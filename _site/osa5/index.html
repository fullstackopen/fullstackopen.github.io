<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>osa 5</title>
  <meta name="description" content="">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/osa5/">
  <link rel="alternate" type="application/rss+xml" title="Full stack open 2018" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Full stack open 2018</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title">osa 5</h1>
  </header>

  <div class="post-content">
    <h2 id="osan-5-oppimistavoitteet">Osan 5 oppimistavoitteet</h2>

<ul>
  <li>React
    <ul>
      <li>child</li>
      <li>ref</li>
      <li>PropTypes</li>
    </ul>
  </li>
  <li>Frontendin testauksen alkeet
    <ul>
      <li>enzyme</li>
      <li>shallow ja full DOM -rendering</li>
    </ul>
  </li>
  <li>Redux
    <ul>
      <li>Flux-pattern</li>
      <li>Storage, reducerit, actionit</li>
      <li>reducereiden testaus, deep-freeze</li>
    </ul>
  </li>
  <li>React+redux
    <ul>
      <li>Storagen välittäminen komponenteille propseilla ja kontekstissa</li>
    </ul>
  </li>
  <li>Javascript
    <ul>
      <li>computed property name</li>
      <li>Spread-operaatio</li>
      <li>Reduxin edellyttämästä funktionaalisesta ohjelmoinnista
        <ul>
          <li>puhtaat funktiot</li>
          <li>immutable</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h2 id="kirjautuminen-react-sovelluksesta">Kirjautuminen React-sovelluksesta</h2>

<p>Kaksi edellistä osaa keskittyivät lähinnä backendin toiminnallisuuteen. Edellisessä osassa backendiin toteutettua käyttäjänhallintaa ei ole tällä hetkellä tuettuna frontendissa millään tavalla.</p>

<p>Frontend näyttää tällä hetkellä olemassaolevat muistiinpanot ja antaa muuttaa niiden tilaa. Uusia muistiinpanoja ei kuitenkaan voi lisätä, sillä osan 4 muutosten myötä backend edellyttää, että lisäyksen mukana on käyttäjän identiteetin varmistava token.</p>

<p>Toteutetaan nyt osa käyttäjienhallinnan edellyttämästä toiminnallisuudesta frontendiin. Aloitetaan käyttäjän kirjautumisesta. Oletetaan vielä tässä osassa, että käyttäjät luodaan suoraan backendiin.</p>

<p>Sovelluksen yläosaan on nyt lisätty kirjautumislomake, myös uuden muistiinpanon lisäämisestä huolehtiva lomake on siirretty sivun yläosaan:</p>

<p><img src="http://localhost:4000/assets/5/1.png" alt="" /></p>

<p>Komponentin <em>App</em> koodi näyttää seuraavalta:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">noteService</span> <span class="k">from</span> <span class="s1">'./services/notes'</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">notes</span><span class="p">:</span> <span class="p">[],</span>
      <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">showAll</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">error</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="na">username</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span>
      <span class="na">user</span><span class="p">:</span> <span class="kc">null</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">noteService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">notes</span> <span class="p">})</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">noteObject</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">content</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newNote</span><span class="p">,</span>
      <span class="na">date</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
      <span class="na">important</span><span class="p">:</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.5</span>
    <span class="p">}</span>

    <span class="nx">noteService</span>
      <span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">noteObject</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">newNote</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
          <span class="na">notes</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">newNote</span><span class="p">),</span>
          <span class="na">newNote</span><span class="p">:</span> <span class="s1">''</span>
        <span class="p">})</span>
      <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">toggleImportanceOf</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>

  <span class="nx">login</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'login in with'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">password</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">handleNoteChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">newNote</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">handlePasswordChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">password</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">handleUsernameChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">toggleVisible</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">showAll</span><span class="p">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">showAll</span> <span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nc">Notification</span> <span class="na">message=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">error</span><span class="si">}</span> <span class="p">/&gt;</span>

        <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Kirjaudu<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">login</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
            käyttäjätunnus
            <span class="p">&lt;</span><span class="nt">input</span>
              <span class="na">type=</span><span class="s2">"text"</span>
              <span class="na">value=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span>
              <span class="na">onChange=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleUsernameChange</span><span class="si">}</span>
            <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
            salasana
            <span class="p">&lt;</span><span class="nt">input</span>
              <span class="na">type=</span><span class="s2">"password"</span>
              <span class="na">value=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">password</span><span class="si">}</span>
              <span class="na">onChange=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handlePasswordChange</span><span class="si">}</span>
            <span class="p">/&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>kirjaudu<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Luo uusi muistiinpano<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">addNote</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span>
            <span class="na">value=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">newNote</span><span class="si">}</span>
            <span class="na">onChange=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleNoteChange</span><span class="si">}</span>
          <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>tallenna<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>

        <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Muistiinpanot<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

        // ...

      <span class="p">&lt;/</span><span class="nt">div</span> <span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">App</span>
</code></pre></div></div>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part5-1">githubissa</a>, tagissa <em>part5-1</em>.</p>

<p>Kirjautumislomakkeen käsittely noudattaa samaa periaatetta kuin <a href="/osa2#lomakkeet">osassa 2</a>. Lomakkeen kenttiä varten on lisätty komponentin tilaan kentät <em>username</em> ja <em>password</em>. Molemmille kentille on rekisteröity muutoksenkäsittelijä (<em>handleUsernameChange</em> ja <em>handlePasswordChange</em>), joka synkronoi kenttään tehdyt muutokset komponentin <em>App</em> tilaan. Kirjautumislomakkeen lähettämisestä vastaava metodi <em>login</em> ei tee vielä mitään.</p>

<p>Jos lomakkeella on paljon kenttiä, voi olla työlästä toteuttaa jokaiselle kentälle oma muutoksenkäsittelijä. React tarjoaakin tapoja, miten yhden muutoksenkäsittelijän avulla on mahdollista huolehtia useista syötekentistä. Jaetun käsittelijän on saatava jollain tavalla tieto minkä syötekentän muutos aiheutti tapahtuman. Eräs tapa tähän on lomakkeen syötekenttien nimeäminen.</p>

<p>Lisätään <em>input</em> elementteihin nimet <em>name</em>-attribuutteina ja vaihdetaan molemmat käyttämään samaa muutoksenkäsittelijää:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;form</span> <span class="na">onSubmit=</span><span class="s">{this.login}</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    käyttäjätunnus
    <span class="nt">&lt;input</span>
      <span class="na">type=</span><span class="s">"text"</span>
      <span class="na">name=</span><span class="s">"username"</span>
      <span class="na">value=</span><span class="s">{this.state.username}</span>
      <span class="na">onChange=</span><span class="s">{this.handleLoginFieldChange}</span>
    <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>
    salasana
    <span class="nt">&lt;input</span>
      <span class="na">type=</span><span class="s">"password"</span>
      <span class="na">name=</span><span class="s">"password"</span>
      <span class="na">value=</span><span class="s">{this.state.password}</span>
      <span class="na">onChange=</span><span class="s">{this.handleLoginFieldChange}</span>
    <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>kirjaudu<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</code></pre></div></div>

<p>Yhteinen muutoksista huolehtiva tapahtumankäsittelijä on seuraava:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">handleLoginFieldChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">'password'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">password</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">'username'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tapahtumankäsittelijän parametrina olevan tapahtumaolion <em>event</em> kentän <em>target.name</em> arvona on tapahtuman aiheuttaneen komponentin <em>name</em>-attribuutti, eli joko <em>username</em> tai <em>password</em>. Koodi haarautuu nimen perusteella ja asettaa tilaan oikean kentän arvon.</p>

<p>Javascriptissa on ES6:n myötä uusi syntaksi <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer">computed property name</a>, jonka avulla olion kentän voi määritellä muuttujan avulla. Esim. seuraava koodi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">field</span> <span class="o">=</span> <span class="s1">'name'</span>

<span class="kd">const</span> <span class="nx">object</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="nx">field</span><span class="p">]</span> <span class="p">:</span> <span class="s1">'Arto Hellas'</span> <span class="p">}</span>
</code></pre></div></div>

<p>määrittelee olion <code>{ name: 'Arto Hellas'}</code></p>

<p>Näin saamme eliminoitua if-lauseen tapahtumankäsittelijästä ja se pelkistyy yhden rivin mittaiseksi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">handleLoginFieldChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="p">[</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">name</span><span class="p">]:</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kirjautuminen tapahtuu tekemällä HTTP POST -pyyntö palvelimen osoitteeseen <em>api/login</em>. Eristetään pyynnön tekevä koodi omaan moduuliin, tiedostoon <em>services/login.js</em>.</p>

<p>Käytetään nyt promisejen sijaan <em>async/await</em>-syntaksia HTTP-pyynnön tekemiseen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>
<span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">'/api/login'</span>

<span class="kd">const</span> <span class="nx">login</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">credentials</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="nx">credentials</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span> <span class="nx">login</span> <span class="p">}</span>
</code></pre></div></div>

<p>Kirjautumisen käsittelystä huolehtiva metodi voidaan toteuttaa seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">login</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="k">try</span><span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">loginService</span><span class="p">.</span><span class="nx">login</span><span class="p">({</span>
      <span class="na">username</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">})</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">user</span><span class="p">})</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="na">error</span><span class="p">:</span> <span class="s1">'käyttäjätunnus tai salasana virheellinen'</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">error</span><span class="p">:</span> <span class="kc">null</span> <span class="p">})</span>
    <span class="p">},</span> <span class="mi">5000</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kirjautumisen onnistuessa nollataan kirjautumislomakkeen kentät <em>ja</em> talletetaan palvelimen vastaus (joka sisältää <em>tokenin</em> sekä kirjautuneen käyttäjän tiedot) sovelluksen tilan kenttään <em>user</em>.</p>

<p>Jos kirjautuminen epäonnistuu, eli metodin <em>loginService.login</em> suoritus aiheuttaa poikkeuksen, ilmoitetaan siitä käyttäjälle.</p>

<p>Onnistunut kirjautuminen ei nyt näy sovelluksen käyttäjälle mitenkään. Muokataan sovellusta vielä siten, että kirjautumislomake näkyy vain <em>jos käyttäjä ei ole kirjautuneena</em> eli <em>this.state.user === null</em> ja uuden muistiinpanon luomislomake vain <em>jos käyttäjä on kirjautuneena</em>, eli (eli <em>this.state.user</em> sisältää kirjautuneen käyttäjän tiedot.</p>

<p>Määritellään ensin komponentin <em>App</em> metodiin render apufunktiot lomakkeiden generointia varten:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const loginForm = () =&gt; (
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Kirjaudu<span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">onSubmit=</span><span class="s">{this.login}</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div&gt;</span>
        käyttäjätunnus
        <span class="nt">&lt;input</span>
          <span class="na">type=</span><span class="s">"text"</span>
          <span class="na">name=</span><span class="s">"username"</span>
          <span class="na">value=</span><span class="s">{this.state.username}</span>
          <span class="na">onChange=</span><span class="s">{this.handleLoginFieldChange}</span>
        <span class="nt">/&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div&gt;</span>
        salasana
        <span class="nt">&lt;input</span>
          <span class="na">type=</span><span class="s">"password"</span>
          <span class="na">name=</span><span class="s">"password"</span>
          <span class="na">value=</span><span class="s">{this.state.password}</span>
          <span class="na">onChange=</span><span class="s">{this.handleLoginFieldChange}</span>
        <span class="nt">/&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>kirjaudu<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
)

const noteForm = () =&gt; (
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;h2&gt;</span>Luo uusi muistiinpano<span class="nt">&lt;/h2&gt;</span>

    <span class="nt">&lt;form</span> <span class="na">onSubmit=</span><span class="s">{this.addNote}</span><span class="nt">&gt;</span>
      <span class="nt">&lt;input</span>
        <span class="na">value=</span><span class="s">{this.state.newNote}</span>
        <span class="na">onChange=</span><span class="s">{this.handleNoteChange}</span>
      <span class="nt">/&gt;</span>
      <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>tallenna<span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;/form&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
)
</code></pre></div></div>

<p>ja renderöidään ne ehdollisesti komponentin <em>App</em> render-metodissa:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>class App extends React.Component <span class="o">{</span>
  // ..
  <span class="k">return</span> <span class="o">(</span>
    &lt;div&gt;
      &lt;h1&gt;Muistiinpanot&lt;/h1&gt;

      &lt;Notification <span class="nv">message</span><span class="o">={</span>this.state.error<span class="o">}</span>/&gt;

      <span class="o">{</span>this.state.user <span class="o">===</span> null <span class="o">&amp;&amp;</span> loginForm<span class="o">()}</span>

      <span class="o">{</span>this.state.user <span class="o">!==</span> null <span class="o">&amp;&amp;</span> noteForm<span class="o">()}</span>


      &lt;h2&gt;Muistiinpanot&lt;/h2&gt;

      // ...

    &lt;/div&gt;
  <span class="o">)</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Lomakkeiden ehdolliseen renderöintiin käytetään hyväksi aluksi hieman erikoiselta näyttävää, mutta Reactin yhteydessä <a href="https://reactjs.org/docs/conditional-rendering.html#inline-if-with-logical--operator">yleisesti käytettyä kikkaa</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">user</span> <span class="o">===</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="nx">loginForm</span><span class="p">()}</span>
</code></pre></div></div>

<p>Jos ensimmäinen osa evaluoituu epätodeksi eli on <a href="https://developer.mozilla.org/en-US/docs/Glossary/Falsy">falsy</a>, ei toista osaa eli lomakkeen generoivaa koodia suoriteta ollenkaan.</p>

<p>Voimme suoraviivaistaa edellistä vielä hieman käyttämällä <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Conditional_Operator">kysymysmerkkioperaattoria</a>:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return (
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Muistiinpanot<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;Notification</span> <span class="na">message=</span><span class="s">{this.state.error}/</span><span class="nt">&gt;</span>

    {this.state.user === null ?
      loginForm() :
      noteForm()
    }

    <span class="nt">&lt;h2&gt;</span>Muistiinpanot<span class="nt">&lt;/h2&gt;</span>

    // ...

  <span class="nt">&lt;/div&gt;</span>
)
</code></pre></div></div>

<p>Eli jos <em>this.state.user === null</em> on <a href="https://developer.mozilla.org/en-US/docs/Glossary/Truthy">truthy</a>, suoritetaan <em>loginForm</em> ja muussa tapauksessa <em>noteForm</em>.</p>

<p>Tehdään vielä sellainen muutos, että jos käyttäjä on kirjautunut, renderöidään kirjautuneet käyttäjän nimi:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>return (
  <span class="nt">&lt;div&gt;</span>
    <span class="nt">&lt;h1&gt;</span>Muistiinpanot<span class="nt">&lt;/h1&gt;</span>

    <span class="nt">&lt;Notification</span> <span class="na">message=</span><span class="s">{this.state.error}/</span><span class="nt">&gt;</span>

    {this.state.user === null ?
      loginForm() :
      <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;p&gt;</span>{this.state.user.name} logged in<span class="nt">&lt;/p&gt;</span>
        {noteForm()}
      <span class="nt">&lt;/div&gt;</span>
    }

    <span class="nt">&lt;h2&gt;</span>Muistiinpanot<span class="nt">&lt;/h2&gt;</span>

    // ...

  <span class="nt">&lt;/div&gt;</span>
)
</code></pre></div></div>

<p>Ratkaisu näyttää hieman rumalta, mutta jätämme sen koodiin toistaiseksi.</p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part5-2">githubissa</a>, tagissa <em>part5-2</em>. <strong>HUOM</strong> koodissa on parissa kohtaa käytetty vahingossa komponentin kentästä nimeä <em>new_note</em>, oikea (seuraaviin tageihin korjattu) muoto on <em>newNote</em>,</p>

<p>Sovelluksemme pääkomponentti <em>App</em> on tällä hetkellä jo aivan liian laaja ja nyt tekemämme muutokset ovat ilmeinen signaali siitä, että lomakkeet olisi syytä refaktoroida omiksi komponenteikseen. Jätämme sen kuitenkin harjoitustehtäväksi.</p>

<h2 id="muistiinpanojen-luominen">Muistiinpanojen luominen</h2>

<p>Frontend on siis tallettanut onnistuneen kirjautumisen yhteydessä backendilta saamansa tokenin sovelluksen tilaan <em>this.state.user.token</em>:</p>

<p><img src="http://localhost:4000/images/5/1b.png" alt="" /></p>

<p>Korjataan uusien muistiinpanojen luominen siihen muotoon, mitä backend edellyttää, eli lisätään kirjautuneen käyttäjän token HTTP-pyynnön Authorization-headeriin.</p>

<p><em>noteService</em>-moduuli muuttuu seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">axios</span> <span class="k">from</span> <span class="s1">'axios'</span>
<span class="kd">const</span> <span class="nx">baseUrl</span> <span class="o">=</span> <span class="s1">'/api/notes'</span>

<span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span>

<span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">setToken</span> <span class="o">=</span> <span class="p">(</span><span class="nx">newToken</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">token</span> <span class="o">=</span> <span class="s2">`bearer </span><span class="p">${</span><span class="nx">newToken</span><span class="p">}</span><span class="s2">`</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">create</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">newObject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="s1">'Authorization'</span><span class="p">:</span> <span class="nx">token</span> <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">baseUrl</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">,</span> <span class="nx">config</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">axios</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">baseUrl</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">id</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">newObject</span><span class="p">)</span>
  <span class="k">return</span> <span class="nx">request</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">response</span> <span class="o">=&gt;</span> <span class="nx">response</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span> <span class="nx">getAll</span><span class="p">,</span> <span class="nx">create</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nx">setToken</span> <span class="p">}</span>
</code></pre></div></div>

<p>Moduulille on määritelty vain moduulin sisällä näkyvä muuttuja <em>token</em>, jolle voidaan asettaa arvo moduulin exporttaamalla funktiolla <em>setToken</em>. Async/await-syntaksiin muutettu <em>create</em> asettaa moduulin tallessa pitämän tokenin <em>Authorization</em>-headeriin, jonka se antaa axiosille metodin <em>post</em> kolmantena parametrina.</p>

<p>Kirjautumisesta huolehtivaa tapahtumankäsittelijää pitää vielä viilata sen verran, että se kutsuu metodia <code>noteService.setToken(user.token)</code> onnistuneen kirjautumisen yhteydessä:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">login</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">loginService</span><span class="p">.</span><span class="nx">login</span><span class="p">({</span>
      <span class="na">username</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">})</span>

    <span class="nx">noteService</span><span class="p">.</span><span class="nx">setToken</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">user</span><span class="p">})</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Uusien muistiinpanojen luominen onnistuu taas!</p>

<h2 id="tokenin-tallettaminen-selaimen-local-storageen">Tokenin tallettaminen selaimen local storageen</h2>

<p>Sovelluksessamme on ikävä piirre: kun sivu uudelleenladataan, tieto käyttäjän kirjautumisesta katoaa. Tämä hidastaa melkoisesti myös sovelluskehitystä, esim. testatessamme uuden muistiinpanon luomista, joudumme joka kerta kirjautumaan järjestelmään.</p>

<p>Ongelma korjaantuu helposti tallettamalla kirjautumistiedot <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage">local storageen</a> eli selaimessa olevaan avain-arvo- eli <a href="https://en.wikipedia.org/wiki/Key-value_database">key-value</a>-periaatteella toimivaan tietokantaan.</p>

<p>Local storage on erittäin helppokäyttöinen. Metodilla <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage/setItem">setItem</a> talletetaan tiettyä <em>avainta</em> vastaava <em>arvo</em>, esim:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'nimi'</span><span class="p">,</span> <span class="s1">'juha tauriainen'</span><span class="p">)</span>
</code></pre></div></div>

<p>tallettaa avaimen <em>nimi</em> arvoksi toisena parametrina olevan merkkijonon.</p>

<p>Avaimen arvo selviää metodilla <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage/getItem">getItem</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'nimi'</span><span class="p">)</span>
</code></pre></div></div>

<p>ja <a href="https://developer.mozilla.org/en-US/docs/Web/API/Storage/removeItem">removeItem</a> poistaa avaimen.</p>

<p>Storageen talletetut arvot säilyvät vaikka sivu uudelleenladattaisiin. Storage on ns. <a href="https://developer.mozilla.org/en-US/docs/Glossary/Origin">origin</a>-kohtainen, eli jokaisella selaimella käytettävällä web-sovelluksella on oma storagensa.</p>

<p>Laajennetaan sovellusta siten, että se asettaa kirjautuneen käyttäjän tiedot local storageen.</p>

<p>Koska storageen talletettavat arvot ovat <a href="https://developer.mozilla.org/en-US/docs/Web/API/DOMString">merkkijonoja</a>, emme voi tallettaa storageen suoraan Javascript-oliota, vaan ne on muutettava ensin JSON-muotoon metodilla <em>JSON.stringify</em>. Vastaavasti kun JSON-muotoinen olio luetaan local storagesta, on se parsittava takaisin Javascript-olioksi metodilla <em>JSON.parse</em>.</p>

<p>Kirjautumisen yhteyteen tehtävä muutos on seuraava:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">login</span> <span class="o">=</span> <span class="k">async</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">loginService</span><span class="p">.</span><span class="nx">login</span><span class="p">({</span>
      <span class="na">username</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span>
      <span class="na">password</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">password</span>
    <span class="p">})</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">'loggedNoteappUser'</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">user</span><span class="p">))</span>
    <span class="nx">noteService</span><span class="p">.</span><span class="nx">setToken</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">username</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="na">password</span><span class="p">:</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">user</span><span class="p">})</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">exception</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kirjautuneen käyttäjän tiedot tallentuvat nyt local storageen ja niitä voidaan tarkastella konsolista:</p>

<p><img src="http://localhost:4000/images/5/2a.png" alt="" /></p>

<p>Sovellusta on vielä laajennettava siten, että kun sivulle tullaan uudelleen, esim. selaimen uudelleenlataamisen yhteydessä, tulee sovelluksen tarkistaa löytyykö local storagesta tiedot kirjautuneesta käyttäjästä. Jos löytyy, asetetaan ne sovelluksen tilaan ja <em>noteServicelle</em>.</p>

<p>Sopiva paikka tähän on <em>App</em>-komponentin metodi <a href="https://reactjs.org/docs/react-component.html#componentDidMount">componentDidMount</a> johon tutustuimme jo <a href="/osa2#komponenttien-lifecycle-metodit">osassa 2</a>.</p>

<p>Kyseessä on siis ns. lifecycle-metodi, jota React-kutsuu heti komponentin ensimmäisen renderöinnin jälkeen. Metodissa on tällä hetkellä jo muistiinpanot palvelimelta lataava koodi. Laajennetaan koodia seuraavasti</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">noteService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">notes</span> <span class="p">})</span>
  <span class="p">)</span>

  <span class="kd">const</span> <span class="nx">loggedUserJSON</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">'loggedNoteappUser'</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">loggedUserJSON</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">loggedUserJSON</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="nx">user</span><span class="p">})</span>
    <span class="nx">noteService</span><span class="p">.</span><span class="nx">setToken</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">token</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Nyt käyttäjä pysyy kirjautuneena sovellukseen ikuisesti. Sovellukseen olisikin kenties syytä lisätä <em>logout</em>-toiminnallisuus, joka poistaisi kirjautumistiedot local storagesta. Jätämme kuitenkin uloskirjautumisen harjoitustehtäväksi.</p>

<p>Meille riittää se, että sovelluksesta on mahdollista kirjautua ulos kirjoittamalla konsoliin</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s1">'loggedNoteappUser'</span><span class="p">)</span>
</code></pre></div></div>

<p>tai local storagen tilan kokonaan nollaavan komennon</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
</code></pre></div></div>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part5-3">githubissa</a>, tagissa <em>part5-3</em>.</p>

<h2 id="tehtäviä">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#osa-5">5.1-5.4</a></p>

<h2 id="kirjautumislomakkeen-näyttäminen-vain-tarvittaessa">Kirjautumislomakkeen näyttäminen vain tarvittaessa</h2>

<p>Muutetaan sovellusta siten, että kirjautumislomaketta ei oletusarvoisesti näytetä:</p>

<p><img src="http://localhost:4000/assets/5/3.png" alt="" /></p>

<p>Lomake aukeaa, jos käyttäjä painaa nappia <em>login</em>:</p>

<p><img src="http://localhost:4000/assets/5/4.png" alt="" /></p>

<p>Napilla <em>cancel</em> käyttäjä saa tarvittaessa suljettua lomakkeen.</p>

<p>Aloitetaan eristämällä kirjautumislomake omaksi komponentikseen:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const LoginForm = ({ handleSubmit, handleChange, username, password }) =&gt; {
  return (
    <span class="nt">&lt;div&gt;</span>
      <span class="nt">&lt;h2&gt;</span>Kirjaudu<span class="nt">&lt;/h2&gt;</span>

      <span class="nt">&lt;form</span> <span class="na">onSubmit=</span><span class="s">{handleSubmit}</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>
          käyttäjätunnus
          <span class="nt">&lt;input</span>
            <span class="na">value=</span><span class="s">{username}</span>
            <span class="na">onChange=</span><span class="s">{handleChange}</span>
            <span class="na">name=</span><span class="s">"username"</span>
          <span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;div&gt;</span>
          salasana
          <span class="nt">&lt;input</span>
            <span class="na">type=</span><span class="s">"password"</span>
            <span class="na">name=</span><span class="s">"password"</span>
            <span class="na">value=</span><span class="s">{password}</span>
            <span class="na">onChange=</span><span class="s">{handleChange}</span>
          <span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>kirjaudu<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  )
}
</code></pre></div></div>

<p>Reactin <a href="https://reactjs.org/docs/lifting-state-up.html">suosittelemaan tyyliin</a> tila ja tilaa käsittelevät funktiot on kaikki määritelty komponentin ulkopuolella ja välitetään komponentille propseina.</p>

<p>Huomaa, että propsit otetaan vastaan <em>destrukturoimalla</em>, eli sen sijaan että määriteltäisiin</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const LoginForm = (props) =&gt; {
  return (
      <span class="nt">&lt;form</span> <span class="na">onSubmit=</span><span class="s">{props.handleSubmit}</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div&gt;</span>
          käyttäjätunnus
          <span class="nt">&lt;input</span>
            <span class="na">value=</span><span class="s">{props.username}</span>
            <span class="na">onChange=</span><span class="s">{props.handleChange}</span>
            <span class="na">name=</span><span class="s">"username"</span>
          <span class="nt">/&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        // ...
        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>kirjaudu<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/form&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  )
}
</code></pre></div></div>

<p>jolloin muuttujan <em>props</em> kenttiin on viitattava muuttujan kautta esim. <em>props.handleSubmit</em>, otetaan kentät suoraan vastaan omiin muuttujiinsa.</p>

<p>Nopea tapa toiminnallisuuden toteuttamiseen on muuttaa komponentin <em>App</em> käyttämä funktio <em>loginForm</em> seuraavaan muotoon:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">loginForm</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">hideWhenVisible</span> <span class="o">=</span> <span class="p">{</span> <span class="na">display</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">loginVisible</span> <span class="p">?</span> <span class="s1">'none'</span> <span class="p">:</span> <span class="s1">''</span> <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">showWhenVisible</span> <span class="o">=</span> <span class="p">{</span> <span class="na">display</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">loginVisible</span> <span class="p">?</span> <span class="s1">''</span> <span class="p">:</span> <span class="s1">'none'</span> <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style=</span><span class="si">{</span><span class="nx">hideWhenVisible</span><span class="si">}</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">loginVisible</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})</span><span class="si">}</span><span class="p">&gt;</span>log in<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style=</span><span class="si">{</span><span class="nx">showWhenVisible</span><span class="si">}</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nc">LoginForm</span>
          <span class="na">visible=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">visible</span><span class="si">}</span>
          <span class="na">username=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">username</span><span class="si">}</span>
          <span class="na">password=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">password</span><span class="si">}</span>
          <span class="na">handleChange=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">handleLoginFieldChange</span><span class="si">}</span>
          <span class="na">handleSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">login</span><span class="si">}</span>
        <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">loginVisible</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span><span class="si">}</span><span class="p">&gt;</span>cancel<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Komponentin <em>App</em> tilaan on nyt lisätty kenttä <em>loginVisible</em> joka määrittelee sen näytetäänkö kirjautumislomake.</p>

<p>Näkyvyyttä säätelevää tilaa vaihdellaan kahden napin avulla, molempiin on kirjoitettu tapahtumankäsittelijän koodi suoraan:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">button</span> <span class="nx">onClick</span><span class="o">=</span><span class="p">{</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">loginVisible</span><span class="p">:</span> <span class="kc">true</span> <span class="p">})}</span><span class="o">&gt;</span><span class="nx">log</span> <span class="k">in</span><span class="p">&lt;</span><span class="err">/</span><span class="nt">button</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">loginVisible</span><span class="p">:</span> <span class="kc">false</span> <span class="p">})</span><span class="si">}</span><span class="p">&gt;</span>cancel<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>Komponenttien näkyvyys on määritelty asettamalla komponentille CSS-määrittely, jossa <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/display">display</a>-propertyn arvoksi asetetaan <em>none</em> jos komponentin ei haluta näkyvän:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const hideWhenVisible = { display: this.state.loginVisible ? 'none' : '' }
const showWhenVisible = { display: this.state.loginVisible ? '' : 'none' }

// ...

<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">{hideWhenVisible}</span><span class="nt">&gt;</span>
  // nappi
<span class="nt">&lt;/div&gt;</span>

<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">{showWhenVisible}</span><span class="nt">&gt;</span>
  // lomake
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Käytössä on taas kysymysmerkkioperaattori, eli jos <em>this.state.visible</em> on <em>true</em>, tulee napin CSS-määrittelyksi</p>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">display</span><span class="o">:</span> <span class="s2">'none'</span><span class="o">;</span>
</code></pre></div></div>

<p>jos <em>this.state.loginVisible</em> on <em>false</em>, ei <em>display</em> saa mitään (napin näkyvyyteen liittyvää) arvoa.</p>

<p>Hyödynsimme mahdollisuutta määritellä React-komponenteille koodin avulla <a href="https://react-cn.github.io/react/tips/inline-styles.html">inline</a>-tyylejä. Palaamme asiaan tarkemmin seuraavassa osassa.</p>

<h2 id="komponentin-lapset-eli-thispropschildren">Komponentin lapset, eli this.props.children</h2>

<p>Kirjautumislomakkeen näkyvyyttä ympäröivän koodin voi ajatella olevan oma looginen kokonaisuutensa ja se onkin hyvä eristää pois komponentista <em>App</em> omaksi komponentikseen.</p>

<p>Tavoitteena on luoda komponentti <em>Togglable</em>, jota käytetään seuraavalla tavalla:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Togglable</span> <span class="na">buttonLabel=</span><span class="s">"login"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;LoginForm</span>
    <span class="na">visible=</span><span class="s">{this.state.visible}</span>
    <span class="na">username=</span><span class="s">{this.state.username}</span>
    <span class="na">password=</span><span class="s">{this.state.password}</span>
    <span class="na">handleChange=</span><span class="s">{this.handleLoginFieldChange}</span>
    <span class="na">handleSubmit=</span><span class="s">{this.login}</span>
  <span class="nt">/&gt;</span>
<span class="nt">&lt;/Togglable&gt;</span>
</code></pre></div></div>

<p>Komponentin käyttö poikkeaa aiemmin näkemistämme siinä, että käytössä on nyt avaava ja sulkeva tagi, joiden sisällä määritellään toinen komponentti eli <em>LoginForm</em>. Reactin terminologiassa <em>LoginForm</em> on nyt komponentin <em>Togglable</em> lapsi.</p>

<p><em>Togglablen</em> avaavan ja sulkevan tagin sisälle voi sijoittaa lapsiksi mitä tahansa React-elementtejä, esim.:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Togglable</span> <span class="na">buttonLabel=</span><span class="s">"paljasta"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;p&gt;</span>tämä on aluksi piilossa<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;p&gt;</span>toinen salainen rivi<span class="nt">&lt;/p&gt;</span>
<span class="nt">&lt;/Togglable&gt;</span>
</code></pre></div></div>

<p>Komponentin koodi on seuraavassa:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Togglable</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">visible</span><span class="p">:</span> <span class="kc">false</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">toggleVisibility</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span><span class="na">visible</span><span class="p">:</span> <span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">visible</span><span class="p">})</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">hideWhenVisible</span> <span class="o">=</span> <span class="p">{</span> <span class="na">display</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">visible</span> <span class="p">?</span> <span class="s1">'none'</span> <span class="p">:</span> <span class="s1">''</span> <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">showWhenVisible</span> <span class="o">=</span> <span class="p">{</span> <span class="na">display</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">visible</span> <span class="p">?</span> <span class="s1">''</span> <span class="p">:</span> <span class="s1">'none'</span> <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style=</span><span class="si">{</span><span class="nx">hideWhenVisible</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleVisibility</span><span class="si">}</span><span class="p">&gt;</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">buttonLabel</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style=</span><span class="si">{</span><span class="nx">showWhenVisible</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="si">}</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleVisibility</span><span class="si">}</span><span class="p">&gt;</span>cancel<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Mielenkiintoista ja meille uutta on <a href="https://reactjs.org/docs/glossary.html#propschildren">this.props.children</a>, jonka avulla koodi viittaa komponentin lapsiin, eli avaavan ja sulkevan tagin sisällä määriteltyihin React-elementteihin.</p>

<p>Tällä kertaa lapset ainoastaan renderöidään komponentin oman renderöivän koodin seassa:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">{showWhenVisible}</span><span class="nt">&gt;</span>
  {this.props.children}
  <span class="nt">&lt;button</span> <span class="na">onClick=</span><span class="s">{this.toggleVisibility}</span><span class="nt">&gt;</span>cancel<span class="nt">&lt;/button&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Toisin kuin “normaalit” propsit, <em>children</em> on Reactin automaattisesti määrittelemä, aina olemassa oleva propsi. Jos komponentti määritellään automaattisesti suljettavalla eli <em>/&gt;</em> loppuvalla tagilla, esim.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Note</span>
  <span class="na">key=</span><span class="s">{note.id}</span>
  <span class="na">note=</span><span class="s">{note}</span>
  <span class="na">toggleImportance=</span><span class="s">{this.toggleImportanceOf(note.id)}</span>
<span class="nt">/&gt;</span>
</code></pre></div></div>

<p>on <em>this.props.children</em> tyhjä taulukko.</p>

<p>Komponentti <em>Togglable</em> on uusiokäytettävä ja voimme käyttää sitä tekemään myös uuden muistiinpanon luomisesta huolehtivan formin vastaavalla tavalla tarpeen mukaan näytettäväksi.</p>

<p>Eristetään ensin muistiinpanojen luominen omaksi komponentiksi</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">NoteForm</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">onSubmit</span><span class="p">,</span> <span class="nx">handleChange</span><span class="p">,</span> <span class="nx">value</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Luo uusi muistiinpano<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="nx">onSubmit</span><span class="si">}</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span>
          <span class="na">value=</span><span class="si">{</span><span class="nx">value</span><span class="si">}</span>
          <span class="na">onChange=</span><span class="si">{</span><span class="nx">handleChange</span><span class="si">}</span>
        <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>tallenna<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ja määritellään lomakkeen näyttävä koodi komponentin <em>Togglable</em> sisällä</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Togglable</span> <span class="na">buttonLabel=</span><span class="s">"new note"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;NoteForm</span>
    <span class="na">onSubmit=</span><span class="s">{this.addNote}</span>
    <span class="na">value=</span><span class="s">{this.state.newNote}</span>
    <span class="na">handleChange=</span><span class="s">{this.handleNoteChange}</span>
  <span class="nt">/&gt;</span>
<span class="nt">&lt;/Togglable&gt;</span>
</code></pre></div></div>

<h2 id="ref-eli-viite-komponenttiin">ref eli viite komponenttiin</h2>

<p>Ratkaisu on melko hyvä, haluaisimme kuitenkin parantaa sitä erään seikan osalta.</p>

<p>Kun uusi muistiinpano luodaan, olisi loogista jos luomislomake menisi piiloon. Nyt lomake pysyy näkyvillä. Lomakkeen piilottamiseen sisältyy kuitenkin pieni ongelma, sillä näkyvyyttä kontrolloidaan <em>Togglable</em>-komponentin tilassa olevalla muuttujalla ja komponentissa määritellyllä metodilla <em>toggleVisibility</em>. Miten pääsemme niihin käsiksi komponentin ulkopuolelta?</p>

<p>Koska React-komponentit ovat Javascript-olioita, on niiden metodeja mahdollista kutsua jos komponenttia vastaavaan olioon onnistutaan saamaan viite.</p>

<p>Eräs keino viitteen saamiseen on React-komponenttien attribuutti <a href="https://reactjs.org/docs/refs-and-the-dom.html#adding-a-ref-to-a-class-component">ref</a>.</p>

<p>Muutetaan lomakkeen renderöivää koodia seuraavasti:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div&gt;
  &lt;Togglable <span class="nv">buttonLabel</span><span class="o">=</span><span class="s2">"new note"</span> <span class="nv">ref</span><span class="o">={</span>component <span class="o">=&gt;</span> this.noteForm <span class="o">=</span> component<span class="o">}&gt;</span>
    &lt;NoteForm
      ...
    /&gt;
  &lt;/Togglable&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Kun komponentti <em>Togglable</em> renderöidään, suorittaa React ref-attribuutin sisällä määritellyn funktion:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">component</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">noteForm</span> <span class="o">=</span> <span class="nx">component</span>
</code></pre></div></div>

<p>parametrin <em>component</em> arvona on viite komponenttiin. Funktio tallettaa viitteen muuttujaan <em>this.noteForm</em> eli <em>App</em>-komponentin kenttään <em>noteForm</em>.</p>

<p>Nyt mistä tahansa komponentin <em>App</em> sisältä on mahdollista päästä käsiksi uusien muistiinpanojen luomisen sisältävään <em>Togglable</em>-komponenttiin.</p>

<p>Voimme nyt piilottaa lomakkeen kutsumalla <em>this.noteForm.toggleVisibility()</em> samalla kun uuden muistiinpanon luominen tapahtuu:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">noteForm</span><span class="p">.</span><span class="nx">toggleVisibility</span><span class="p">()</span>

  <span class="c1">// ..</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Refeille on myös <a href="https://reactjs.org/docs/refs-and-the-dom.html">muita käyttötarkoituksia</a> kuin React-komponentteihin käsiksi pääseminen.</p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part5-4">githubissa</a>, tagissa <em>part5-4</em>.</p>

<h3 id="huomio-komponenteista">Huomio komponenteista</h3>

<p>Kun Reactissa määritellään komponentti</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Togglable</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ja otetaan se käyttöön seuraavasti</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
  <span class="p">&lt;</span><span class="nc">Togglable</span> <span class="na">buttonLabel=</span><span class="s2">"1"</span> <span class="na">ref=</span><span class="si">{</span><span class="nx">component</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t1</span> <span class="o">=</span> <span class="nx">component</span><span class="si">}</span><span class="p">&gt;</span>
    ensimmäinen
  <span class="p">&lt;/</span><span class="nc">Togglable</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nc">Togglable</span> <span class="na">buttonLabel=</span><span class="s2">"2"</span> <span class="na">ref=</span><span class="si">{</span><span class="nx">component</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t2</span> <span class="o">=</span> <span class="nx">component</span><span class="si">}</span><span class="p">&gt;</span>
    toinen
  <span class="p">&lt;/</span><span class="nc">Togglable</span><span class="p">&gt;</span>

  <span class="p">&lt;</span><span class="nc">Togglable</span> <span class="na">buttonLabel=</span><span class="s2">"3"</span> <span class="na">ref=</span><span class="si">{</span><span class="nx">component</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">t3</span> <span class="o">=</span> <span class="nx">component</span><span class="si">}</span><span class="p">&gt;</span>
    kolmas
  <span class="p">&lt;/</span><span class="nc">Togglable</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="err">/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div></div>

<p>syntyy <em>kolme erillistä komponenttiolioa</em>, joilla on kaikilla oma tilansa:</p>

<p><img src="http://localhost:4000/assets/5/5.png" alt="" /></p>

<p><em>ref</em>-attribuutin avulla on talletettu viite jokaiseen komponenttiin muuttujiin <em>this.t1</em>, <em>this.t2</em> ja <em>this.t3</em>.</p>

<h2 id="tehtäviä-1">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#komponenttien-näyttäminen-vain-tarvittaessa">5.5-5.10</a></p>

<h2 id="proptypes">PropTypes</h2>

<p>Komponentti <em>Togglable</em> olettaa, että sille määritellään propsina <em>buttonLabel</em> napin teksti. Jos määrittely unohtuu</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Togglable&gt;</span>
  buttonLabel unohtui...
<span class="nt">&lt;/Togglable&gt;</span>
</code></pre></div></div>

<p>Sovellus kyllä toimii, mutta selaimeen renderöityy hämäävästi nappi, jolla ei ole mitään tekstiä.</p>

<p>Haluaisimmekin varmistaa että jos <em>Togglable</em>-komponenttia käytetään, on propsille “pakko” antaa arvo.</p>

<p>Kirjaston olettamat ja edellyttämät propsit ja niiden tyypit voidaan määritellä kirjaston <a href="https://github.com/facebook/prop-types">prop-types</a> avulla. Asennetaan kirjasto</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install <span class="nt">--save</span> prop-types
</code></pre></div></div>

<p><em>buttonLabel</em> voidaan määritellä <em>pakolliseksi</em> string-tyyppiseksi propsiksi seuraavasti</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">PropTypes</span> <span class="k">from</span> <span class="s1">'prop-types'</span>

<span class="kd">class</span> <span class="nx">Togglable</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="nx">Togglable</span><span class="p">.</span><span class="nx">propTypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">buttonLabel</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">isRequired</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Jos propsia ei määritellä, seurauksena on konsoliin tulostuva virheilmoitus</p>

<p><img src="http://localhost:4000/assets/5/6.png" alt="" /></p>

<p>Koodi kuitenkin toimii edelleen, eli mikään ei pakota määrittelemään propseja PropTypes-määrittelyistä huolimatta. On kuitenkin erittäin epäprofessionaalia jättää konsoliin <em>mitään</em> punaisia tulosteita.</p>

<p>Määritellään Proptypet myös <em>LoginForm</em>-komponentille:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">PropTypes</span> <span class="k">from</span> <span class="s1">'prop-types'</span>

<span class="kd">const</span> <span class="nx">LoginForm</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">handleSubmit</span><span class="p">,</span> <span class="nx">handleChange</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="c1">// ...</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="nx">LoginForm</span><span class="p">.</span><span class="nx">propTypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">handleSubmit</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">func</span><span class="p">.</span><span class="nx">isRequired</span><span class="p">,</span>
  <span class="na">handleChange</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">func</span><span class="p">.</span><span class="nx">isRequired</span><span class="p">,</span>
  <span class="na">username</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">isRequired</span><span class="p">,</span>
  <span class="na">password</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">isRequired</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Funktionaalisen komponentin proptypejen määrittely tapahtuu samalla tavalla kuin luokkaperustaisten.</p>

<p>Jos propsin tyyppi on väärä, esim. yritetään määritellä propsiksi <em>handleChange</em> merkkijono, seurauksena on varoitus:</p>

<p><img src="http://localhost:4000/assets/5/7.png" alt="" /></p>

<p>Luokkaperustaisille komponenteille PropTypet on mahdollista määritellä myös <em>luokkamuuttujina</em>, seuraavalla syntaksilla:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">PropTypes</span> <span class="k">from</span> <span class="s1">'prop-types'</span>

<span class="kd">class</span> <span class="nx">Togglable</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kr">static</span> <span class="nx">propTypes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">buttonLabel</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">isRequired</span>
  <span class="p">}</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Muuttujamäärittelyn edessä oleva <em>static</em> määrittelee nyt, että <em>propTypes</em>-kenttä on nimenomaan komponentin määrittelevällä luokalla <em>Togglable</em> eikä luokan instansseilla. Oleellisesti ottaen kyseessä on ainoastaan Javascriptin vielä standardoimattoman <a href="https://github.com/tc39/proposal-class-fields">ominaisuuden</a> mahdollistava syntaktinen oikotie määritellä seuraava:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Togglable</span><span class="p">.</span><span class="nx">propTypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">buttonLabel</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">isRequired</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Surffatessasi internetissä saatat vielä nähdä ennen Reactin versiota 0.16 tehtyjä esimerkkejä, joissa PropTypejen käyttö ei edellytä erillistä kirjastoa. Versiosta 0.16 alkaen PropTypejä ei enää määritelty React-kirjastossa itsessään ja kirjaston <em>prop-types</em> käyttö on pakollista.</p>

<h2 id="tehtäviä-2">Tehtäviä</h2>

<p>Tee nyt tehtävä <a href="/tehtävät#proptypet">5.11</a></p>

<h2 id="react-sovelluksen-testaus">React-sovelluksen testaus</h2>

<p>Reactilla tehtyjen frontendien testaamiseen on monia tapoja. Aloitetaan niihin tutustuminen nyt.</p>

<p>Testit tehdään samaan tapaan kuin edellisessä osassa eli Facebookin <a href="https://facebook.github.io/jest/">Jest</a>-kirjastolla. Jest onkin valmiiksi konfiguroitu create-react-app:illa luotuihin projekteihin.</p>

<p>Jestin lisäksi käytetään AirBnB:n kehittämää <a href="https://github.com/airbnb/enzyme">enzyme</a>-kirjastoa.</p>

<p>Asennetaan enzyme komennolla:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install <span class="nt">--save-dev</span> enzyme enzyme-adapter-react-16
</code></pre></div></div>

<p>Testataan aluksi muistiinpanon renderöivää komponenttia:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const Note = ({ note, toggleImportance }) =&gt; {
  const label = note.important ? 'make not important' : 'make important'
  return (
    <span class="nt">&lt;div</span> <span class="na">className=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">className=</span><span class="s">"content"</span><span class="nt">&gt;</span>
        {note.content}
      <span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;button</span> <span class="na">onClick=</span><span class="s">{toggleImportance}</span><span class="nt">&gt;</span>{label}<span class="nt">&lt;/button&gt;</span>
      <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  )
}
</code></pre></div></div>

<p>Testauksen helpottamiseksi komponenttiin on lisätty sisällön määrittelevälle <em>div</em>-elementille <a href="https://reactjs.org/docs/dom-elements.html#classname">CSS-luokka</a> <em>content</em>.</p>

<h3 id="shallow-renderöinti">shallow-renderöinti</h3>

<p>Ennen testien tekemistä, tehdään <em>enzymen</em> konfiguraatioita varten tiedosto <em>src/setupTests.js</em> ja sille seuraava sisältö:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">configure</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'enzyme'</span>
<span class="k">import</span> <span class="nx">Adapter</span> <span class="k">from</span> <span class="s1">'enzyme-adapter-react-16'</span>

<span class="nx">configure</span><span class="p">({</span> <span class="na">adapter</span><span class="p">:</span> <span class="k">new</span> <span class="nx">Adapter</span><span class="p">()</span> <span class="p">})</span>
</code></pre></div></div>

<p>Nyt olemme valmiina testien tekemiseen.</p>

<p>Koska <em>Note</em> on yksinkertainen komponentti, joka ei käytä yhtään monimutkaista alikomponenttia vaan renderöi suoraan HTML:ää, sopii sen testaamiseen hyvin enzymen <a href="http://airbnb.io/enzyme/docs/api/shallow.html">shallow</a>-renderöijä.</p>

<p>Tehdään testi tiedoston <em>src/components/Note.test.js</em>, eli samaan hakemistoon, missä komponentti itsekin sijaitsee.</p>

<p>Ensimmäinen testi varmistaa, että komponentti renderöi muistiinpanon sisällön:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import React from 'react'
import { shallow } from 'enzyme'
import Note from './Note'

describe.only('<span class="nt">&lt;Note</span> <span class="nt">/&gt;</span>', () =&gt; {
  it('renders content', () =&gt; {
    const note = {
      content: 'Komponenttitestaus tapahtuu jestillä ja enzymellä',
      important: true
    }

    const noteComponent = shallow(<span class="nt">&lt;Note</span> <span class="na">note=</span><span class="s">{note}</span> <span class="nt">/&gt;</span>)
    const contentDiv = noteComponent.find('.content')

    expect(contentDiv.text()).toContain(note.content)
  })
})
</code></pre></div></div>

<p>Edellisessä osassa määrittelimme testitapaukset metodin <a href="https://facebook.github.io/jest/docs/en/api.html#testname-fn-timeout">test</a> avulla. Nyt käytössä oleva <em>it</em> viittaa samaan olioon kuin <em>test</em>, eli on sama kumpaa käytät. It on tietyissä piireissä suositumpi ja käytössä mm. Enzymen dokumentaatiossa joten käytämme it-muotoa tässä osassa.</p>

<p>Alun konfiguroinnin jälkeen testi renderöi komponentin metodin <em>shallow</em> avulla:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code>const noteComponent = shallow(<span class="nt">&lt;Note</span> <span class="na">note=</span><span class="s">{note}</span> <span class="nt">/&gt;</span>)
</code></pre></div></div>

<p>Normaalisti React-komponentit renderöityvät <em>DOM</em>:iin. Nyt kuitenkin renderöimme komponentteja <a href="http://airbnb.io/enzyme/docs/api/shallow.html">shallowWrapper</a>-tyyppisiksi, testaukseen sopiviksi olioiksi.</p>

<p>ShallowWrapper-muotoon renderöidyillä React-komponenteilla on runsaasti metodeja, joiden avulla niiden sisältöä voidaan tutkia. Esimerkiksi <a href="http://airbnb.io/enzyme/docs/api/ShallowWrapper/find.html">find</a> mahdollistaa komponentin sisällä olevien <em>elementtien</em> etsimisen <a href="http://airbnb.io/enzyme/docs/api/selector.html">enzyme-selektorien</a> avulla. Eräs tapa elementtien etsimiseen on <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Selectors">CSS-selektorien</a> käyttö. Liitimme muisiinpanon sisällön kertovaan div-elementtiin luokan <em>content</em>, joten voimme etsiä elementin seuraavasti:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">contentDiv</span> <span class="o">=</span> <span class="nx">noteComponent</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.content'</span><span class="p">)</span>
</code></pre></div></div>

<p>ekspektaatiossa varmistamme, että elementtiin on renderöitynyt oikea teksti, eli muistiinpanon sisältö:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">expect</span><span class="p">(</span><span class="nx">contentDiv</span><span class="p">.</span><span class="nx">text</span><span class="p">()).</span><span class="nx">toContain</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="testien-suorittaminen">Testien suorittaminen</h3>

<p>Create-react-app:issa on konfiguroitu testit oletusarvoisesti suoritettavaksi ns. watch-moodissa, eli jos suoritat testit komennolla <em>npm test</em>, jää konsoli odottamaan koodissa tapahtuvia muutoksia. Muutosten jälkeen testit suoritetaan automaattisesti ja Jest alkaa taas odottamaan uusia muutoksia koodiin.</p>

<p>Jos haluat ajaa testit “normaalisti”, se onnistuu komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CI</span><span class="o">=</span><span class="nb">true </span>npm <span class="nb">test</span>
</code></pre></div></div>

<p>Mikäli testejä suoritettaessa ei löydetä tiedostossa <em>src/setupTests.js</em> tehtyä adapterin konfigurointia, auttaa seuraavan asetuksen lisääminen tiedostoon package-lock.json:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  "jest": {
    ...
    "setupFiles": [
      "&lt;rootDir&gt;/src/setupTests.js"
    ],
    ...
  }
</code></pre></div></div>

<h3 id="testien-sijainti">Testien sijainti</h3>

<p>Reactissa on (ainakin) <a href="https://medium.com/@JeffLombardJr/organizing-tests-in-jest-17fc431ff850">kaksi erilaista</a> konventiota testien sijoittamiseen. Sijoitimme testit ehkä vallitsevan tavan mukaan, eli samaan hakemistoon missä testattava komponentti sijaitsee.</p>

<p>Toinen tapa olisi sijoittaa testit “normaaliin” tapaan omaan erilliseen hakemistoon. Valitaanpa kumpi tahansa tapa, on varmaa että se on jonkun mielestä täysin väärä.</p>

<p>Itse en pidä siitä, että testit ja normaali koodi ovat samassa hakemistossa. Noudatamme kuitenkin nyt tätä tapaa, sillä se on oletusarvo create-react-app:illa konfiguroiduissa sovelluksissa.</p>

<h3 id="testien-debuggaaminen">Testien debuggaaminen</h3>

<p>Testejä tehdessä törmäämme tyypillisesti erittäin moniin ongelmiin. Näissä tilanteissa vanha kunnon <em>console.log</em> on hyödyllinen. Voimme tulostaa <em>shallow</em>-metodin avulla renderöityjä komponentteja ja niiden sisällä olevia elementtejä metodin <a href="http://airbnb.io/enzyme/docs/api/ShallowWrapper/debug.html">debug</a> avulla:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>describe.only<span class="o">(</span><span class="s1">'&lt;Note /&gt;'</span>, <span class="o">()</span> <span class="o">=&gt;</span> <span class="o">{</span>
  it<span class="o">(</span><span class="s1">'renders content'</span>, <span class="o">()</span> <span class="o">=&gt;</span> <span class="o">{</span>
    const note <span class="o">=</span> <span class="o">{</span>
      content: <span class="s1">'Komponenttitestaus tapahtuu jestillä ja enzymellä'</span>,
      important: <span class="nb">true</span>
    <span class="o">}</span>

    const noteComponent <span class="o">=</span> shallow<span class="o">(</span>&lt;Note <span class="nv">note</span><span class="o">={</span>note<span class="o">}</span> /&gt;<span class="o">)</span>
    console.log<span class="o">(</span>noteComponent.debug<span class="o">())</span>


    const contentDiv <span class="o">=</span> noteComponent.find<span class="o">(</span><span class="s1">'.content'</span><span class="o">)</span>
    console.log<span class="o">(</span>contentDiv.debug<span class="o">())</span>

    // ...
  <span class="o">})</span>
<span class="o">})</span>
</code></pre></div></div>

<p>Konsoliin tulostuu komponentin generoima html:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>console.log src/components/Note.test.js:16
  &lt;div <span class="nv">className</span><span class="o">=</span><span class="s2">"wrapper"</span><span class="o">&gt;</span>
    &lt;div <span class="nv">className</span><span class="o">=</span><span class="s2">"content"</span><span class="o">&gt;</span>
      Komponenttitestaus tapahtuu jestillä ja enzymellä
    &lt;/div&gt;
    &lt;div&gt;
      &lt;button <span class="nv">onClick</span><span class="o">={[</span>undefined]<span class="o">}&gt;</span>
        make not important
      &lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;

console.log src/components/Note.test.js:20
  &lt;div <span class="nv">className</span><span class="o">=</span><span class="s2">"content"</span><span class="o">&gt;</span>
    Komponenttitestaus tapahtuu jestillä ja enzymellä
  &lt;/div&gt;
</code></pre></div></div>

<h3 id="nappien-painelu-testeissä">Nappien painelu testeissä</h3>

<p>Sisällön näyttämisen lisäksi toinen <em>Note</em>-komponenttien vastuulla oleva asia on huolehtia siitä, että painettaessa noten yhteydessä olevaa nappia, tulee propsina välitettyä tapahtumankäsittelijäfunktiota <em>toggleImportance</em> kutsua.</p>

<p>Testaus onnistuu seuraavasti:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>it<span class="o">(</span><span class="s1">'clicking the button calls event handler once'</span>, <span class="o">()</span> <span class="o">=&gt;</span> <span class="o">{</span>
  const note <span class="o">=</span> <span class="o">{</span>
    content: <span class="s1">'Komponenttitestaus tapahtuu jestillä ja enzymellä'</span>,
    important: <span class="nb">true</span>
  <span class="o">}</span>

  const mockHandler <span class="o">=</span> jest.fn<span class="o">()</span>

  const noteComponent <span class="o">=</span> shallow<span class="o">(</span>
    &lt;Note
      <span class="nv">note</span><span class="o">={</span>note<span class="o">}</span>
      <span class="nv">toggleImportance</span><span class="o">={</span>mockHandler<span class="o">}</span>
    /&gt;
  <span class="o">)</span>

  const button <span class="o">=</span> noteComponent.find<span class="o">(</span><span class="s1">'button'</span><span class="o">)</span>
  button.simulate<span class="o">(</span><span class="s1">'click'</span><span class="o">)</span>

  expect<span class="o">(</span>mockHandler.mock.calls.length<span class="o">)</span>.toBe<span class="o">(</span>1<span class="o">)</span>
<span class="o">})</span>
</code></pre></div></div>

<p>Testissä on muutama mielenkiintoinen seikka. Tapahtumankäsittelijäksi annetaan Jestin avulla määritelty <a href="https://facebook.github.io/jest/docs/en/mock-functions.html">mock</a>-funktio:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">mockHandler</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>
</code></pre></div></div>

<p>Testi hakee renderöidystä komponentista <em>button</em>-elementin ja klikkaa sitä. Koska komponentissa on ainoastaan yksi nappi, on sen hakeminen helppoa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">noteComponent</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'button'</span><span class="p">)</span>
<span class="nx">button</span><span class="p">.</span><span class="nx">simulate</span><span class="p">(</span><span class="s1">'click'</span><span class="p">)</span>
</code></pre></div></div>

<p>Klikkaaminen tapahtuu metodin <a href="http://airbnb.io/enzyme/docs/api/ShallowWrapper/simulate.html">simulate</a> avulla.</p>

<p>Testin ekspektaatio varmistaa, että <em>mock-funktiota</em> on kutsuttu täsmälleen kerran:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">expect</span><span class="p">(</span><span class="nx">mockHandler</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">calls</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p><a href="https://en.wikipedia.org/wiki/Mock_object">Mockoliot ja -funktiot</a> ovat testauksessa yleisesti käytettyjä valekomponentteja, joiden avulla korvataan testattavien komponenttien riippuvuuksia, eli niiden tarvitsemia muita komponentteja. Mockit mahdollistavat mm. kovakoodattujen syötteiden palauttamisen sekä niiden metodikutsujen lukumäärän sekä parametrien testauksen aikaisen tarkkailun.</p>

<p>Esimerkissämme mock-funktio sopi tarkoitukseen erinomaisesti, sillä sen avulla on helppo varmistaa, että metodia on kutsuttu täsmälleen kerran.</p>

<h3 id="komponentin-togglable-testit">Komponentin <em>Togglable</em> testit</h3>

<p>Tehdään komponentille <em>Togglable</em> muutama testi. Lisätään komponentin lapset renderöivään div-elementtiin CSS-luokka <em>togglableContent</em>:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Togglable</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">hideWhenVisible</span> <span class="o">=</span> <span class="p">{</span> <span class="na">display</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">visible</span> <span class="p">?</span> <span class="s1">'none'</span> <span class="p">:</span> <span class="s1">''</span> <span class="p">}</span>
    <span class="kd">const</span> <span class="nx">showWhenVisible</span> <span class="o">=</span> <span class="p">{</span> <span class="na">display</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">visible</span> <span class="p">?</span> <span class="s1">''</span> <span class="p">:</span> <span class="s1">'none'</span> <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style=</span><span class="si">{</span><span class="nx">hideWhenVisible</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleVisibility</span><span class="si">}</span><span class="p">&gt;</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">buttonLabel</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">style=</span><span class="si">{</span><span class="nx">showWhenVisible</span><span class="si">}</span> <span class="na">className=</span><span class="s2">"togglableContent"</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">children</span><span class="si">}</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleVisibility</span><span class="si">}</span><span class="p">&gt;</span>cancel<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Testit ovat seuraavassa</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">shallow</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'enzyme'</span>
<span class="k">import</span> <span class="nx">Adapter</span> <span class="k">from</span> <span class="s1">'enzyme-adapter-react-16'</span>
<span class="k">import</span> <span class="nx">Note</span> <span class="k">from</span> <span class="s1">'./Note'</span>
<span class="k">import</span> <span class="nx">Togglable</span> <span class="k">from</span> <span class="s1">'./Togglable'</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'&lt;Togglable /&gt;'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">togglableComponent</span>

  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">togglableComponent</span> <span class="o">=</span> <span class="nx">shallow</span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nc">Togglable</span> <span class="na">buttonLabel=</span><span class="s2">"show..."</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">className=</span><span class="s2">"testDiv"</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nc">Togglable</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'renders its children'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">togglableComponent</span><span class="p">.</span><span class="nx">contains</span><span class="p">(&lt;</span><span class="nt">div</span> <span class="na">class=</span><span class="s2">"testDiv"</span> <span class="p">/&gt;)).</span><span class="nx">toEqual</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'at start the children are not displayed'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">togglableComponent</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.togglableContent'</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">div</span><span class="p">.</span><span class="nx">getElement</span><span class="p">().</span><span class="nx">props</span><span class="p">.</span><span class="nx">style</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">display</span><span class="p">:</span> <span class="s1">'none'</span> <span class="p">})</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'after clicking the button, children are displayed'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">togglableComponent</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'button'</span><span class="p">)</span>

    <span class="nx">button</span><span class="p">.</span><span class="nx">at</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">simulate</span><span class="p">(</span><span class="s1">'click'</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">div</span> <span class="o">=</span> <span class="nx">togglableComponent</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'.togglableContent'</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">div</span><span class="p">.</span><span class="nx">getElement</span><span class="p">().</span><span class="nx">props</span><span class="p">.</span><span class="nx">style</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">display</span><span class="p">:</span> <span class="s1">''</span> <span class="p">})</span>
  <span class="p">})</span>

<span class="p">})</span>
</code></pre></div></div>

<p>Ennen jokaista testiä suoritettava <em>beforeEach</em> alustaa shallow-renderöimällä <em>Togglable</em>-komponentin muuttujaan <em>togglableComponent</em>.</p>

<p>Ensimmäinen testi tarkastaa, että <em>Togglable</em> renderöi lapsikomponentin <em>&lt;div class="testDiv" /&gt;</em>. Loput testit varmistavat, että Togglablen sisältämä lapsikomponentti on alussa näkymättömissä, eli sen sisältävään <em>div</em>-elementin liittyy tyyli <em>{ display: ‘none’ }</em>, ja että nappia painettaessa komponentti näkyy, eli tyyli on <em>{ display: ‘’ }</em>. Koska Togglablessa on kaksi nappia, painallusta simuloidessa niistä pitää valita oikea, eli tällä kertaa ensimmäinen.</p>

<h2 id="tehtäviä-3">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#komponenttien-testaaminen">5.12-14</a></p>

<h3 id="mount-ja-full-dom--renderöinti">mount ja full DOM -renderöinti</h3>

<p>Käyttämämme <em>shallow</em>-renderöijä on useimmista tapauksissa riittävä. Joskus tarvitsemme kuitenkin järeämmän työkalun sillä <em>shallow</em> renderöi ainoastaan “yhden tason”, eli sen komponentin, jolle metodia kutsutaan.</p>

<p>Jos yritämme esim. sijoittaa kaksi <em>Note</em>-komponenttia <em>Togglable</em>-komponentin sisälle ja tulostamme syntyvän <em>ShallowWrapper</em> -olion</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>it<span class="o">(</span><span class="s1">'shallow renders only one level'</span>, <span class="o">()</span> <span class="o">=&gt;</span> <span class="o">{</span>
  const note1 <span class="o">=</span> <span class="o">{</span>
    content: <span class="s1">'Komponenttitestaus tapahtuu jestillä ja enzymellä'</span>,
    important: <span class="nb">true</span>
  <span class="o">}</span>
  const note2 <span class="o">=</span> <span class="o">{</span>
    content: <span class="s1">'shallow ei renderöi alikomponentteja'</span>,
    important: <span class="nb">true</span>
  <span class="o">}</span>

  const togglableComponent <span class="o">=</span> shallow<span class="o">(</span>
    &lt;Togglable <span class="nv">buttonLabel</span><span class="o">=</span><span class="s2">"show..."</span><span class="o">&gt;</span>
      &lt;Note <span class="nv">note</span><span class="o">={</span>note1<span class="o">}</span> /&gt;
      &lt;Note <span class="nv">note</span><span class="o">={</span>note2<span class="o">}</span> /&gt;
    &lt;/Togglable&gt;
  <span class="o">)</span>

  console.log<span class="o">(</span>togglableComponent.debug<span class="o">())</span>
<span class="o">})</span>
</code></pre></div></div>

<p>huomaamme, että <em>Togglable</em> komponentti on renderöitynyt, eli “muuttunut” HTML:ksi, mutta sen sisällä olevat <em>Note</em>-komponentit eivät ole HTML:ää vaan React-komponentteja.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;div&gt;
  &lt;div <span class="nv">style</span><span class="o">=&gt;</span>
    &lt;button <span class="nv">onClick</span><span class="o">={[</span>Function]<span class="o">}&gt;</span>
      show...
    &lt;/button&gt;
  &lt;/div&gt;
  &lt;div <span class="nv">style</span><span class="o">=</span> <span class="nv">className</span><span class="o">=</span><span class="s2">"togglableContent"</span><span class="o">&gt;</span>
    &lt;Note <span class="nv">note</span><span class="o">=</span> /&gt;
    &lt;Note <span class="nv">note</span><span class="o">=</span> /&gt;
    &lt;button <span class="nv">onClick</span><span class="o">={[</span>Function]<span class="o">}&gt;</span>
      cancel
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/div&gt;
</code></pre></div></div>

<p>Jos komponentille tehdään edellisten esimerkkien tapaan yksikkötestejä, <em>shallow</em>-renderöinti on useimmiten riittävä. Jos haluamme testata isompia kokonaisuuksia, eli tehdä frontendin <em>integraatiotestausta</em>, ei <em>shallow</em>-renderöinti riitä vaan on turvauduttava komponentit kokonaisuudessaan renderöivään <a href="http://airbnb.io/enzyme/docs/api/mount.html">mount</a>:iin.</p>

<p>Muutetaan testi käyttämään <em>shallowin</em> sijaan <em>mountia</em>:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">shallow</span><span class="p">,</span> <span class="nx">mount</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'enzyme'</span>
<span class="k">import</span> <span class="nx">Note</span> <span class="k">from</span> <span class="s1">'./Note'</span>
<span class="k">import</span> <span class="nx">Togglable</span> <span class="k">from</span> <span class="s1">'./Togglable'</span>

<span class="nx">it</span><span class="p">(</span><span class="s1">'mount renders all components'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">note1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'Komponenttitestaus tapahtuu jestillä ja enzymellä'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>
  <span class="kd">const</span> <span class="nx">note2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'mount renderöi myös alikomponentit'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="kd">const</span> <span class="nx">noteComponent</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">Togglable</span> <span class="na">buttonLabel=</span><span class="s2">"show..."</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nc">Note</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note1</span><span class="si">}</span> <span class="p">/&gt;</span>
      <span class="p">&lt;</span><span class="nc">Note</span> <span class="na">note=</span><span class="si">{</span><span class="nx">note2</span><span class="si">}</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nc">Togglable</span><span class="p">&gt;</span>
  <span class="p">)</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">noteComponent</span><span class="p">.</span><span class="nx">debug</span><span class="p">())</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Tuloksena on kokonaisuudessaan HTML:ksi renderöitynyt <em>Togglable</em>-komponentti:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Togglable <span class="nv">buttonLabel</span><span class="o">=</span><span class="s2">"show..."</span><span class="o">&gt;</span>
  &lt;div&gt;
    &lt;div <span class="nv">style</span><span class="o">=&gt;</span>
      &lt;button <span class="nv">onClick</span><span class="o">={[</span>Function]<span class="o">}&gt;</span>
        show...
      &lt;/button&gt;
    &lt;/div&gt;
    &lt;div <span class="nv">style</span><span class="o">=</span> <span class="nv">className</span><span class="o">=</span><span class="s2">"togglableContent"</span><span class="o">&gt;</span>
      &lt;Note <span class="nv">note</span><span class="o">=&gt;</span>
        &lt;div <span class="nv">className</span><span class="o">=</span><span class="s2">"wrapper"</span><span class="o">&gt;</span>
          &lt;div <span class="nv">className</span><span class="o">=</span><span class="s2">"content"</span><span class="o">&gt;</span>
            Komponenttitestaus tapahtuu jestillä ja enzymellä
          &lt;/div&gt;
          &lt;div&gt;
            &lt;button <span class="nv">onClick</span><span class="o">={[</span>undefined]<span class="o">}&gt;</span>
              make not important
            &lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/Note&gt;
      &lt;Note <span class="nv">note</span><span class="o">=&gt;</span>
        &lt;div <span class="nv">className</span><span class="o">=</span><span class="s2">"wrapper"</span><span class="o">&gt;</span>
          &lt;div <span class="nv">className</span><span class="o">=</span><span class="s2">"content"</span><span class="o">&gt;</span>
            mount renderöi myös alikomponentit
          &lt;/div&gt;
          &lt;div&gt;
            &lt;button <span class="nv">onClick</span><span class="o">={[</span>undefined]<span class="o">}&gt;</span>
              make not important
            &lt;/button&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/Note&gt;
      &lt;button <span class="nv">onClick</span><span class="o">={[</span>Function]<span class="o">}&gt;</span>
        cancel
      &lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/Togglable&gt;
</code></pre></div></div>

<p>Mountin avulla renderöitäessä testi pääsee siis käsiksi periaatteessa samaan HTML-koodiin, joka todellisuudessa renderöidään selaimeen ja tämä luonnollisesti mahdollistaa huomattavasti monipuolisemman testauksen kuin <em>shallow</em>-renderöinti. Komennolla <em>mount</em> tapahtuva renderöinti on kuitenkin hitaampaa, joten jos <em>shallow</em> riittää, sitä kannattaa käyttää.</p>

<p>Huomaa, että testin käyttämä metodi <a href="http://airbnb.io/enzyme/docs/api/ReactWrapper/debug.html">debug</a> ei palauta todellista HTML:ää vaan debuggaustarkoituksiin sopivan tekstuaalisen esitysmuodon komponentista. Todellisessa HTML:ssä ei mm. ole ollenkaan React-komponenttien tageja.</p>

<p>Jos on tarvetta tietää, mikä on testattaessa syntyvä todellinen HTML, sen saa selville metodilla <a href="http://airbnb.io/enzyme/docs/api/ReactWrapper/html.html">html</a>.</p>

<p>Jos muutamme testin viimeisen komennon muotoon</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">noteComponent</span><span class="p">.</span><span class="nx">html</span><span class="p">())</span>
</code></pre></div></div>
<p>tulostuu todellinen HTML:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div&gt;</span>
  <span class="nt">&lt;div&gt;&lt;button&gt;</span>show...<span class="nt">&lt;/button&gt;&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">"display: none;"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>Komponenttitestaus tapahtuu jestillä ja enzymellä<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div&gt;&lt;button&gt;</span>make not important<span class="nt">&lt;/button&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>mount renderöi myös alikomponentit<span class="nt">&lt;/div&gt;</span>
      <span class="nt">&lt;div&gt;&lt;button&gt;</span>make not important<span class="nt">&lt;/button&gt;&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;button&gt;</span>cancel<span class="nt">&lt;/button&gt;&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>Komennon <em>mount</em> palauttamaa renderöidyn “komponenttipuun” <a href="http://airbnb.io/enzyme/docs/api/mount.htm">ReactWrapper</a>-tyyppisenä oliona, joka tarjoaa hyvin samantyyppisen rajapinnan komponentin sisällön tutkimiseen kuin <em>ShallowWrapper</em>.</p>

<h3 id="lomakkeiden-testaus">Lomakkeiden testaus</h3>

<p>Lomakkeiden testaaminen Enzymellä on jossain määrin haasteellista. Enzymen dokumentaatio ei mainitse lomakkeista sanaakaan. <a href="https://github.com/airbnb/enzyme/issues/364">Issueissa</a> asiasta kuitenkin keskustellaan.</p>

<p>Tehdään testi komponentille <em>NoteForm</em>. Lomakkeen koodi näyttää seuraavalta</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">NoteForm</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">onSubmit</span><span class="p">,</span> <span class="nx">handleChange</span><span class="p">,</span> <span class="nx">value</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Luo uusi muistiinpano<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>

      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="nx">onSubmit</span><span class="si">}</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span>
          <span class="na">value=</span><span class="si">{</span><span class="nx">value</span><span class="si">}</span>
          <span class="na">onChange=</span><span class="si">{</span><span class="nx">handleChange</span><span class="si">}</span>
        <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>tallenna<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Lomakkeen toimintaperiaatteena on synkronoida lomakkeen tila sen ulkopuolella olevan React-komponentin tilaan. Lomakettamme on jossain määrin vaikea testata yksistään.</p>

<p>Teemmekin testejä varten apukomponentin <em>Wrapper</em>, joka renderöi <em>NoteForm</em>:in ja hallitsee lomakkeen tilaa:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">Wrapper</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">formInput</span><span class="p">:</span> <span class="s1">''</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="nx">onChange</span> <span class="o">=</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="na">formInput</span><span class="p">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">})</span>
  <span class="p">}</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nc">NoteForm</span>
        <span class="na">value=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">formInput</span><span class="si">}</span>
        <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">onSubmit</span><span class="si">}</span>
        <span class="na">handleChange=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">onChange</span><span class="si">}</span>
      <span class="p">/&gt;</span>
  <span class="p">)}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Testi on seuraavassa:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">mount</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'enzyme'</span>
<span class="k">import</span> <span class="nx">NoteForm</span> <span class="k">from</span> <span class="s1">'./NoteForm'</span>

<span class="nx">it</span><span class="p">(</span><span class="s1">'renders content'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">onSubmit</span> <span class="o">=</span> <span class="nx">jest</span><span class="p">.</span><span class="nx">fn</span><span class="p">()</span>

  <span class="kd">const</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">Wrapper</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="nx">onSubmit</span><span class="si">}</span> <span class="p">/&gt;</span>
  <span class="p">)</span>

  <span class="kd">const</span> <span class="nx">input</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'input'</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">button</span> <span class="o">=</span> <span class="nx">wrapper</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s1">'button'</span><span class="p">)</span>

  <span class="nx">input</span><span class="p">.</span><span class="nx">simulate</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="p">{</span> <span class="na">target</span><span class="p">:</span> <span class="p">{</span> <span class="na">value</span><span class="p">:</span> <span class="s1">'lomakkeiden testaus on hankalaa'</span> <span class="p">}</span> <span class="p">})</span>
  <span class="nx">button</span><span class="p">.</span><span class="nx">simulate</span><span class="p">(</span><span class="s1">'submit'</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">.</span><span class="nx">state</span><span class="p">().</span><span class="nx">formInput</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="s1">'lomakkeiden testaus on hankalaa'</span><span class="p">)</span>
  <span class="nx">expect</span><span class="p">(</span><span class="nx">onSubmit</span><span class="p">.</span><span class="nx">mock</span><span class="p">.</span><span class="nx">calls</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Testi luo <em>Wrapper</em>-komponentin, jolle se välittää propseina mockatun funktion <em>onSubmit</em>. Wrapper välittää funktion edelleen <em>NoteFormille</em> tapahtuman <em>onSubmit</em> käsittelijäksi.</p>

<p>Syötekenttään <em>input</em> kirjoittamista simuloidaan tekemällä syötekenttään tapahtuma <em>change</em> ja määrittelemällä sopiva olio, joka määrittelee syötekenttään ‘kirjoitetun’ sisällön.</p>

<p>Lomakkeen nappia tulee painaa simuloimalla tapahtumaa <em>submit</em>, tapahtuma <em>click</em> ei lähetä lomaketta.</p>

<p>Testin ensimmäinen ekspektaatio tutkii komponentin <em>Wrapper</em> tilaa metodilla <a href="http://airbnb.io/enzyme/docs/api/ReactWrapper/state.html">state</a>, ja varmistaa, että lomakkeelle kirjoitettu teksti on siirtynyt tilaan. Toinen ekspektaatio varmistaa, että lomakkeen lähetys on aikaansaanut tapahtumankäsittelijän kutsumisen.</p>

<h2 id="frontendin-integraatiotestaus">Frontendin integraatiotestaus</h2>

<p>Suoritimme edellisessä osassa backendille integraatiotestejä, jotka testasivat backendin tarjoaman API:n läpi backendia ja tietokantaa. Backendin testauksessa tehtiin tietoinen päätös olla kirjoittamatta yksikkötestejä sillä backendin koodi on melko suoraviivaista ja ongelmat tulevatkin esiin todennäköisemmin juuri monimutkaisemmissa skenaarioissa, joita integraatiotestit testaavat hyvin.</p>

<p>Toistaiseksi kaikki frontendiin tekemämme testit ovat olleet yksittäisten komponenttien oikeellisuutta valvovia yksikkötestejä. Yksikkötestaus on toki tärkeää, mutta kattavinkaan yksikkötestaus ei riitä antamaan riittävää luotettavuutta sille, että järjestelmä toimii kokonaisuudessaan.</p>

<p>Tehdään nyt sovellukselle yksi integraatiotesti. Integraatiotestaus on huomattavasti komponenttien yksikkötestausta hankalampaa. Erityisesti sovelluksemme kohdalla ongelmia aiheuttaa kaksi seikkaa: sovellus hakee näytettävät muistiinpanot palvelimelta <em>ja</em> sovellus käyttää local storagea kirjautuneen käyttäjän tietojen tallettamiseen.</p>

<p>Local storage ei ole oletusarvoiseti käytettävissä testejä suorittaessa, sillä kyseessä on selaimen tarjoama toiminnallisuus ja testit ajetaan selaimen ulkopuolella. Ongelma on helppo korjata määrittelemällä testien suorituksen ajaksi <em>mock</em> joka matkii local storagea. Tapoja tähän on <a href="https://stackoverflow.com/questions/32911630/how-do-i-deal-with-localstorage-in-jest-tests">monia</a>.</p>

<p>Koska testimme ei edellytä local storagelta juuri mitään toiminnallisuutta, teemme tiedostoon <a href="https://github.com/facebookincubator/create-react-app/blob/ed5c48c81b2139b4414810e1efe917e04c96ee8d/packages/react-scripts/template/README.md#initializing-test-environment">src/setupTests.js</a> hyvin yksinkertaisen mockin</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">savedItems</span> <span class="o">=</span> <span class="p">{}</span>

<span class="kd">const</span> <span class="nx">localStorageMock</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">setItem</span><span class="p">:</span> <span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">savedItems</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span>
  <span class="p">},</span>
  <span class="na">getItem</span><span class="p">:</span> <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">savedItems</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span>
  <span class="na">clear</span><span class="p">:</span> <span class="nx">savedItems</span> <span class="o">=</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span> <span class="o">=</span> <span class="nx">localStorageMock</span>
</code></pre></div></div>

<p>Toinen ongelmistamme on se, että sovellus hakee näytettävät muistiinpanot palvelimelta. Muistiinpanojen haku tapahtuu heti komponentin <em>App</em> luomisen jälkeen, kun metodi <em>componentDidMount</em> kutsuu <em>noteService</em>:n metodia <em>getAll</em>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">noteService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">notes</span> <span class="p">})</span>
  <span class="p">)</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Jestin <a href="https://facebook.github.io/jest/docs/en/manual-mocks.html#content">manual mock</a> -konsepti tarjoaa tilanteeseen hyvän ratkaisun. Manual mockien avulla voidaan kokonainen moduuli, tässä tapauksessa <em>noteService</em> korvata testien ajaksi vaihtoehtoisella esim. kovakoodattua dataa tarjoavalla toiminnallisuudella.</p>

<p>Luodaan Jestin ohjeiden mukaisesti hakemistoon <em>src/services</em> alihakemisto <em>__mocks__</em> (alussa ja lopussa kaksi alaviivaa) ja sinne tiedosto <em>notes.js</em> jonka määrittelemä metodi <em>getAll</em> palauttaa kovakoodatun listan muistiinpanoja:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">token</span> <span class="o">=</span> <span class="kc">null</span>

<span class="kd">const</span> <span class="nx">notes</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="s2">"5a451df7571c224a31b5c8ce"</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s2">"HTML on helppoa"</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s2">"2017-12-28T16:38:15.541Z"</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="s2">"5a437a9e514ab7f168ddf138"</span><span class="p">,</span>
      <span class="na">username</span><span class="p">:</span> <span class="s2">"mluukkai"</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="s2">"Matti Luukkainen"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="s2">"5a451e21e0b8b04a45638211"</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s2">"Selain pystyy suorittamaan vain javascriptiä"</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s2">"2017-12-28T16:38:57.694Z"</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="s2">"5a437a9e514ab7f168ddf138"</span><span class="p">,</span>
      <span class="na">username</span><span class="p">:</span> <span class="s2">"mluukkai"</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="s2">"Matti Luukkainen"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="s2">"5a451e30b5ffd44a58fa79ab"</span><span class="p">,</span>
    <span class="na">content</span><span class="p">:</span> <span class="s2">"HTTP-protokollan tärkeimmät metodit ovat GET ja POST"</span><span class="p">,</span>
    <span class="na">date</span><span class="p">:</span> <span class="s2">"2017-12-28T16:39:12.713Z"</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">user</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">_id</span><span class="p">:</span> <span class="s2">"5a437a9e514ab7f168ddf138"</span><span class="p">,</span>
      <span class="na">username</span><span class="p">:</span> <span class="s2">"mluukkai"</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="s2">"Matti Luukkainen"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>

<span class="kd">const</span> <span class="nx">getAll</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">notes</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="p">{</span> <span class="nx">getAll</span><span class="p">,</span> <span class="nx">notes</span> <span class="p">}</span>
</code></pre></div></div>

<p>Määritelty metodi <em>getAll</em> palauttaa muistiinpanojen listan käärittynä promiseksi metodin <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/resolve">Promise.resolve</a> avulla sillä käytettäessä metodia, oletetaan sen paluuarvon olevan promise:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">noteService</span><span class="p">.</span><span class="nx">getAll</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">notes</span> <span class="o">=&gt;</span>
</code></pre></div></div>

<p>Olemme valmiina määrittelemään testin:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">mount</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'enzyme'</span>
<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="s1">'./App'</span>
<span class="k">import</span> <span class="nx">Note</span> <span class="k">from</span> <span class="s1">'./components/Note'</span>
<span class="nx">jest</span><span class="p">.</span><span class="nx">mock</span><span class="p">(</span><span class="s1">'./services/notes'</span><span class="p">)</span>
<span class="k">import</span> <span class="nx">noteService</span> <span class="k">from</span> <span class="s1">'./services/notes'</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'&lt;App /&gt;'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">let</span> <span class="nx">app</span>
  <span class="nx">beforeAll</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">app</span> <span class="o">=</span> <span class="nx">mount</span><span class="p">(</span><span class="o">&lt;</span><span class="nx">App</span> <span class="o">/&gt;</span><span class="p">)</span>
  <span class="p">})</span>

  <span class="nx">it</span><span class="p">(</span><span class="s1">'renders all notes it gets from backend'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">app</span><span class="p">.</span><span class="nx">update</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">noteComponents</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">Note</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">noteComponents</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">(</span><span class="nx">noteService</span><span class="p">.</span><span class="nx">notes</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Komennolla <em>jest.mock(‘./services/notes’)</em> otetaan juuri määritelty mock käyttöön. Loogisempi paikka komennolle olisi kenties testien määrittelyt tekevä tiedosto <em>src/setupTests.js</em></p>

<p>Testin toimivuuden kannalta on oleellista metodin <a href="http://airbnb.io/enzyme/docs/api/ReactWrapper/update.html">app.update</a> kutsuminen, näin pakotetaan sovellus renderöitymään uudelleen siten, että myös mockatun backendin palauttamat muistiinpanot renderöityvät.</p>

<h2 id="testauskattavuus">Testauskattavuus</h2>

<p><a href="https://github.com/facebookincubator/create-react-app/blob/ed5c48c81b2139b4414810e1efe917e04c96ee8d/packages/react-scripts/template/README.md#coverage-reporting">Testauskattavuus</a> saadaan helposti selville suorittamalla testit komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CI</span><span class="o">=</span><span class="nb">true </span>npm <span class="nb">test</span> <span class="nt">--</span> <span class="nt">--coverage</span>
</code></pre></div></div>

<p><img src="http://localhost:4000/assets/5/8.png" alt="" /></p>

<p>Melko primitiivinen HTML-muotoinen raportti generoituu hakemistoon <em>coverage/lcov-report</em>. HTML-muotoinen raportti kertoo mm. yksittäisen komponenttien testaamattomat koodirivit:</p>

<p><img src="http://localhost:4000/assets/5/9.png" alt="" /></p>

<p>Huomaamme, että parannettavaa jäi vielä runsaasti.</p>

<p>Sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/part2-notes/tree/part5-5">githubissa</a>, tagissa <em>part5-5</em>.</p>

<h2 id="tehtäviä-4">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#integraatiotestaus">5.15 ja 5.16</a></p>

<h2 id="snapshot-testaus">Snapshot-testaus</h2>

<p>Jest tarjoaa “perinteisen” testaustavan lisäksi aivan uudenlaisen tavan testaukseen, ns. <a href="https://facebook.github.io/jest/docs/en/snapshot-testing.html">snapshot</a>-testauksen. Mielenkiintoista snapshot-testauksessa on se, että sovelluskehittäjän ei tarvitse itse määritellä ollenkaan testejä, snapshot-testauksen käyttöönotto riittää.</p>

<p>Periaatteena on verrata komponenttien määrittelemää HTML:ää aina koodin muutoksen jälkeen siihen, minkälaisen HTML:n komponentit määrittelivät ennen muutosta.</p>

<p>Jos snapshot-testi huomaa muutoksen komponenttien määrittelemässä HTML:ssä, voi kyseessä joko olla haluttu muutos tai vahingossa aiheutettu “bugi”. Snapshot-testi huomauttaa sovelluskehittäjälle, jos komponentin määrittelemä HTML muuttuu. Sovelluskehittäjä kertoo muutosten yhteydessä, oliko muutos haluttu. Jos muutos tuli yllätyksenä, eli kyseessä oli bugi, sovelluskehittäjä huomaa sen snapshot-testauksen ansiosta nopeasti.</p>

<h2 id="end-to-end--testaus">End to end -testaus</h2>

<p>Olemme tehneet sekä backendille että frontendille hieman niitä kokonaisuutena testavia integraatiotestejä. Eräs tärkeä testauksen kategoria on vielä käsittelemättä, <a href="https://en.wikipedia.org/wiki/System_testing">järjestelmää kokonaisuutena</a> testaavat “end to end” (eli E2E) -testit.</p>

<p>Web-sovellusten E2E-testaus tapahtuu simuloidun selaimen avulla esimerkiksi <a href="http://www.seleniumhq.org">Selenium</a>-kirjastoa käyttäen. Toinen vaihtoehto on käyttää ns. <a href="https://en.wikipedia.org/wiki/Headless_browser">headless browseria</a> eli selainta, jolla ei ole ollenkaan graafista käyttöliittymää. Esim. Chromea on mahdollista suorittaa Headless-moodissa.</p>

<p>E2E testit ovat potentiaalisesti kaikkein hyödyllisin testikategoria, sillä ne tutkivat järjestelmää saman rajapinnan kautta kuin todelliset käyttäjät.</p>

<p>E2E-testeihin liittyy myös ikäviä puolia. Niiden konfigurointi on haastavampaa kuin yksikkö- ja integraatiotestien. E2E-testit ovat tyypillisesti myös melko hitaita ja isommassa ohjelmistossa niiden suoritusaika voi helposti nousta minuutteihin, tai jopa tunteihin. Tämä on ikävää sovelluskehityksen kannalta, sillä sovellusta koodatessa on erittäin hyödyllistä pystyä ajamaan testejä mahdollisimman usein koodin regressioiden varalta.</p>

<p>Palaamme end to end -testeihin kurssin viimeisessä, eli seitsemännessä osassa.</p>

<h2 id="sovellusten-tilan-hallinta-reduxilla">Sovellusten tilan hallinta Reduxilla</h2>

<p>Olemme noudattaneet sovelluksen tilan hallinnassa Reactin suosittelemaa käytäntöä määritellä tila ja sitä käsittelevät metodit <a href="https://reactjs.org/docs/lifting-state-up.html">sovelluksen juurikomponentissa</a>. Tilaa ja metodeja on välitetty propsien avulla niitä tarvitseville komponenteille. Tämä toimii johonkin pisteeseen saakka, mutta kun sovellusten koko kasvaa, muuttuu tilan hallinta haasteelliseksi.</p>

<h3 id="flux-arkkitehtuuri">Flux-arkkitehtuuri</h3>

<p>Facebook kehitti tilan hallinnan ongelmia helpottamaan <a href="https://facebook.github.io/flux/docs/in-depth-overview.html#content">Flux</a>-arkkitehtuurin. Fluxissa sovelluksen tilan hallinta erotetaan kokonaan Reactin komponenttien ulkopuolisiin varastoihin eli <em>storeihin</em>. Storessa olevaa tilaa ei muuteta suoraan, vaan tapahtumien eli <em>actionien</em> avulla.</p>

<p>Kun action muuttaa storen tilaa, renderöidään näkymät uudelleen:</p>

<p><img src="https://facebook.github.io/flux/img/flux-simple-f8-diagram-1300w.png" alt="" /></p>

<p>Jos sovelluksen käyttö, esim. napin painaminen aiheuttaa tarpeen tilan muutokseen, tehdään tilanmuutos actonin avulla. Tämä taas aiheuttaa uuden näytön renderöitymisen:</p>

<p><img src="https://facebook.github.io/flux/img/flux-simple-f8-diagram-with-client-action-1300w.png" alt="" /></p>

<p>Flux tarjoaa siis standardin tavan sille miten ja missä sovelluksen tila pidetään sekä tavalle tehdä tilaan muutoksia.</p>

<h3 id="redux">Redux</h3>

<p>Facebookilla on olemassa valmis toteutus Fluxille, käytämme kuitenkin saman periaatteen mukaan toimivaa, mutta hieman yksinkertaisempaa <a href="https://redux.js.org">Redux</a>-kirjastoa, jota myös Facebookilla käytetään nykyään alkuperäisen Flux-toteutuksen sijaan.</p>

<p>Tutustutaan Reduxiin tekemällä laskurin toteuttava sovellus:</p>

<p><img src="http://localhost:4000/assets/5/10.png" alt="" /></p>

<p>Tehdään uusi create-react-app-sovellus ja asennetaan siihen <em>redux</em> komennolla</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install redux <span class="nt">--save</span>
</code></pre></div></div>

<p>Fluxin tapaan Reduxissa sovelluksen tila talletetaan <a href="https://redux.js.org/basics/store">storeen</a>.</p>

<p>Koko sovelluksen tila talletetaan <em>yhteen</em> storen tallettamaan Javascript-objektiin. Koska sovelluksemme ei tarvitse mitään muuta tilaa kuin laskurin arvon, talletetaan se storeen suoraan. Jos sovelluksen tila olisi monipuolisempi, talletettaisiin “eri asiat” storessa olevan olioon erillisinä kenttinä.</p>

<p>Storen tilaa muutetaan <a href="https://redux.js.org/basics/actions">actionien</a> avulla. Actionit ovat olioita, joilla on vähintään actionin <em>tyypin</em> määrittelevä kenttä <em>type</em>. Sovelluksessamme tarvitsemme esimerkiksi seuraavaa actionia:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Jos actioneihin liittyy dataa, määritellään niille tarpeen vaatiessa muitakin kenttiä. Laskurisovelluksemme on kuitenkin niin yksinkertainen, että actioneille riittää pelkkä tyyppikenttä.</p>

<p>Actionien vaikutus sovelluksen tilaan määritellään <a href="https://redux.js.org/basics/reducers">reducerin</a> avulla. Käytännössä reducer on funktio, joka saa parametrikseen olemassaolevan staten tilan sekä actionin ja <em>palauttaa</em> staten uuden tilan.</p>

<p>Määritellään nyt sovelluksellemme reduceri:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">counterReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'INCREMENT'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">state</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'DECREMENT'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">state</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'ZERO'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">0</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">state</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ensimmäinen parametri on siis storessa oleva <em>tila</em>. Reducer palauttaa uuden tilan actionin tyypin mukaan.</p>

<p>Muutetaan koodia vielä hiukan. Reducereissa on tapana käyttää if:ien sijaan <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/switch">switch</a>-komentoa.
Määritellään myös parametrille <em>state</em> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Default_parameters">oletusarvoksi</a> 0. Näin reducer toimii vaikka store -tilaa ei olisi vielä alustettu.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">counterReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'INCREMENT'</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">state</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">case</span> <span class="s1">'DECREMENT'</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">state</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">case</span> <span class="s1">'ZERO'</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">state</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Reduceria ei ole tarkoitus kutsua koskaan suoraan sovelluksen koodista. Reducer ainoastaan annetaan parametrina storen luovalle <em>createStore</em>-funktiolle:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span><span class="nx">createStore</span><span class="p">}</span> <span class="k">from</span> <span class="s1">'redux'</span>

<span class="kd">const</span> <span class="nx">counterReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">counterReducer</span><span class="p">)</span>
</code></pre></div></div>

<p>Store käyttää nyt reduceria käsitelläkseen <em>actioneja</em>, jotka <em>dispatchataan</em> eli “lähetetään” storagelle sen <a href="https://redux.js.org/api-reference/store#dispatch(action)">dispatch</a>-metodilla:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span><span class="p">})</span>
</code></pre></div></div>

<p>Storen tilan saa selville metodilla <a href="https://redux.js.org/api-reference/store#getstate()">getState</a>.</p>

<p>Esim. seuraava koodi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">counterReducer</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">())</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span><span class="p">})</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span><span class="p">})</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span><span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">())</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="s1">'ZERO'</span><span class="p">})</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span><span class="na">type</span><span class="p">:</span> <span class="s1">'DECREMENT'</span><span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">())</span>
</code></pre></div></div>

<p>tulostaisi konsoliin</p>

<pre>
0
3
-1
</pre>

<p>sillä ensin storen tila on 0. Kolmen <em>INCREMENT</em>-actionin jälkeen tila on 3, ja lopulta actionien <em>ZERO</em> ja <em>DECREMENT</em> jälkeen -1.</p>

<p>Kolmas tärkeä metodi storella on <a href="https://redux.js.org/api-reference/store#subscribe(listener)">subscribe</a>, jonka avulla voidaan määritellä takaisinkutsufunktioita, joita store kutsuu sen tilan muuttumisen yhteydessä.</p>

<p>Jos esim. lisäisimme seuraavan funktion subscribellä, tulostuisi <em>jokainen storen muutos</em> konsoliin.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">store</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">storeNow</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">storeNow</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div></div>

<p>eli koodi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">counterReducer</span><span class="p">)</span>

<span class="nx">store</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">storeNow</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">()</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">storeNow</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span> <span class="p">})</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span> <span class="p">})</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span> <span class="p">})</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'ZERO'</span> <span class="p">})</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'DECREMENT'</span> <span class="p">})</span>
</code></pre></div></div>

<p>aiheuttaisi tulostuksen</p>

<pre>
1
2
3
0
-1
</pre>

<p>Laskurisovelluksemme koodi on seuraavassa. Kaikki koodi on kirjoitettu samaan tiedostoon, jolloin <em>store</em> on suoraan React-koodin käytettävissä. Tutustumme React/Redux-koodin parempiin strukturointitapoihin myöhemmin.</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>
<span class="k">import</span> <span class="p">{</span><span class="nx">createStore</span><span class="p">}</span> <span class="k">from</span> <span class="s1">'redux'</span>

<span class="kd">const</span> <span class="nx">counterReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'INCREMENT'</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">state</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">case</span> <span class="s1">'DECREMENT'</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">state</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">case</span> <span class="s1">'ZERO'</span><span class="p">:</span>
      <span class="k">return</span> <span class="mi">0</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">state</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">counterReducer</span><span class="p">)</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">()</span><span class="si">}</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'INCREMENT'</span><span class="p">})</span><span class="si">}</span><span class="p">&gt;</span>
          plus
        <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'DECREMENT'</span> <span class="p">})</span><span class="si">}</span><span class="p">&gt;</span>
          minus
        <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span> <span class="na">type</span><span class="p">:</span> <span class="s1">'ZERO'</span> <span class="p">})</span><span class="si">}</span><span class="p">&gt;</span>
          zero
        <span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">renderApp</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nc">App</span> <span class="p">/&gt;,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">))</span>
<span class="p">}</span>

<span class="nx">renderApp</span><span class="p">()</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">renderApp</span><span class="p">)</span>
</code></pre></div></div>

<p>Koodissa on pari huomionarvoista seikkaa. <em>App</em> renderöi laskurin arvon kysymällä sitä storesta metodilla <em>store.getState()</em>. Nappien tapahtumankäsittelijät <em>dispatchaavat</em> suoraan oikean tyyppiset actionit storelle.</p>

<p>Kun storessa olevan tilan arvo muuttuu, ei React osaa automaattisesti renderöidä sovellusta uudelleen. Olemmekin rekisteröineet koko sovelluksen renderöinnin suorittavan funktion <em>renderApp</em> kuuntelemaan storen muutoksia metodilla <em>store.subscribe</em>. Huomaa, että joudumme kutsumaan heti alussa metodia <em>renderApp()</em>, ilman kutsua sovelluksen ensimmäistä renderöintiä ei koskaan tapahdu.</p>

<h2 id="redux-muistiinpanot">Redux-muistiinpanot</h2>

<p>Tavoitteenamme on muuttaa muistiinpanosovellus käyttämään tilanhallintaan reduxia. Katsotaan kuitenkin ensin eräitä konsepteja hieman yksinkertaistetun muistiinpanosovelluksen kautta.</p>

<p>Sovelluksen ensimmäinen versio seuraavassa</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">noteReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'NEW_NOTE'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">state</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">state</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">noteReducer</span><span class="p">)</span>

<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
  <span class="na">type</span><span class="p">:</span> <span class="s1">'NEW_NOTE'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'sovelluksen tila talletetaan storeen'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">1</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
  <span class="na">type</span><span class="p">:</span> <span class="s1">'NEW_NOTE'</span><span class="p">,</span>
  <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'tilanmuutokset tehdään actioneilla'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">}</span>
<span class="p">})</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span><span class="o">=&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="p">&gt;</span>
              <span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span> <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">?</span> <span class="s1">'tärkeä'</span> <span class="p">:</span> <span class="s1">''</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
          <span class="p">)</span><span class="si">}</span>
         <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Toistaiseksi sovelluksessa ei siis ole toiminnallisuutta uusien muistiinpanojen lisäämiseen, voimme kuitenkin tehdä sen dispatchaamalla <em>NEW_NOTE</em>-tyyppisiä actioneja koodista.</p>

<p>Actioneissa on nyt tyypin lisäksi kenttä <em>data</em>, joka sisältää lisättävän muistiinpanon:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="s1">'NEW_NOTE'</span><span class="p">,</span>
  <span class="nx">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">content</span><span class="p">:</span> <span class="s1">'tilanmuutokset tehdään actioneilla'</span><span class="p">,</span>
    <span class="nx">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">id</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="puhtaat-funktiot-immutable">puhtaat funktiot, immutable</h3>

<p>Reducerimme alustava versio on yksinkertainen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">noteReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'NEW_NOTE'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">state</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">state</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">state</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Tila on nyt taulukko. <em>NEW_NOTE</em>-tyyppisen actionin seurauksena tilaan lisätään uusi muistiinpano metodilla <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/push">push</a>.</p>

<p>Sovellus näyttää toimivan, mutta määrittelemämme reduceri on huono, se rikkoo Reactin reducerien <a href="https://github.com/reactjs/redux/blob/master/docs/basics/Reducers.md#handling-actions">perusolettamusta</a> siitä, että reducerien tulee olla <a href="https://en.wikipedia.org/wiki/Pure_function">puhtaita funktioita</a>.</p>

<p>Puhtaat funktiot ovat sellaisia, että ne <em>eivät aiheuta mitään sivuvaikutuksia</em> ja niiden tulee aina palauttaa sama vastaus samoilla parametreilla kutsuttaessa.</p>

<p>Lisäsimme tilaan uuden muistiinpanon metodilla <em>state.push(action.data)</em> joka <em>muuttaa</em> state-olion tilaa. Tämä ei ole sallittua. Ongelma korjautuu helposti käyttämällä metodia <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/concat">concat</a>, joka luo <em>uuden taulukon</em>, jonka sisältönä on vanhan taulukon alkiot sekä lisättävä alkio:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">noteReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="s1">'NEW_NOTE'</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">state</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Reducen tilan tulee koostua muuttumattomista eli <a href="https://en.wikipedia.org/wiki/Immutable_object">immutable</a> olioista. Jos tilaan tulee muutos, ei vanhaa oliota muuteta, vaan se <em>korvataan uudella muuttuneella oliolla</em>. Juuri näin toimimme uudistuneessa reducerissa, vanha taulukko korvaantuu uudella.</p>

<p>Laajennetaan reduceria siten, että se osaa käsitellä muistiinpanon tärkeyteen liittyvän muutoksen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
  <span class="nl">type</span><span class="p">:</span> <span class="s1">'TOGGLE_IMPORTANCE'</span><span class="p">,</span>
  <span class="nx">data</span><span class="p">:</span> <span class="p">{</span>
    <span class="nl">id</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Koska meillä ei ole vielä koodia joka käyttää ominaisuutta, laajennetaan reduceria testivetoisesti. Aloitetaan tekemällä testi actionin <em>NEW_NOTE</em> käsittelylle.</p>

<p>Jotta testaus olisi helpompaa, siirretään reducerin koodi ensin omaan moduuliinsa tiedostoon <em>src/noteReducer.js</em>. Otetaan käyttöön myös kirjasto <a href="https://github.com/substack/deep-freeze">deep-freeze</a>, jonka avulla voimme varmistaa, että reducer on määritelty oikeaoppisesti puhtaana funktiona. Asennetaan kirjasto kehitysaikaiseksi riippuvuudeksi</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">npm</span> <span class="nx">install</span> <span class="o">--</span><span class="nx">save</span><span class="o">-</span><span class="nx">dev</span> <span class="nx">deep</span><span class="o">-</span><span class="nx">freeze</span>
</code></pre></div></div>

<p>Testi on seuraavassa:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">noteReducer</span> <span class="k">from</span> <span class="s1">'./noteReducer'</span>
<span class="k">import</span> <span class="nx">deepFreeze</span> <span class="k">from</span> <span class="s1">'deep-freeze'</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'noteRenderer'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'returns new state with action NEW_NOTE'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'NEW_NOTE'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">content</span><span class="p">:</span> <span class="s1">'sovelluksen tila talletetaan storeen'</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="na">id</span><span class="p">:</span> <span class="mi">1</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">deepFreeze</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
    <span class="kd">const</span> <span class="nx">newState</span> <span class="o">=</span> <span class="nx">noteReducer</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span>

    <span class="nx">expect</span><span class="p">(</span><span class="nx">newState</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">newState</span><span class="p">).</span><span class="nx">toContainEqual</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Komento <em>deepFreeze(state)</em> varmistaa, että reducer ei muuta parametrina olevaa storen tilaa. Jos reduceri käyttää state:n manipulointiin komentoa <em>push</em>, testi ei mene läpi</p>

<p><img src="http://localhost:4000/assets/5/11.png" alt="" /></p>

<p>Tehdään sitten testi actionin <em>TOGGLE_IMPORTANCE</em> käsittelylle:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">it</span><span class="p">(</span><span class="s1">'returns new state with action TOGGLE_IMPORTANCE'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">state</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="na">content</span><span class="p">:</span> <span class="s1">'sovelluksen tila talletetaan storeen'</span><span class="p">,</span>
      <span class="na">important</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="na">content</span><span class="p">:</span> <span class="s1">'tilanmuutokset tehdään actioneilla'</span><span class="p">,</span>
      <span class="na">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}]</span>

  <span class="kd">const</span> <span class="nx">action</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'TOGGLE_IMPORTANCE'</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">id</span><span class="p">:</span> <span class="mi">2</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">deepFreeze</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
  <span class="kd">const</span> <span class="nx">newState</span> <span class="o">=</span> <span class="nx">noteReducer</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span> <span class="nx">action</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">newState</span><span class="p">.</span><span class="nx">length</span><span class="p">).</span><span class="nx">toBe</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">newState</span><span class="p">).</span><span class="nx">toContainEqual</span><span class="p">(</span><span class="nx">state</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

  <span class="nx">expect</span><span class="p">(</span><span class="nx">newState</span><span class="p">).</span><span class="nx">toContainEqual</span><span class="p">({</span>
    <span class="na">content</span><span class="p">:</span> <span class="s1">'tilanmuutokset tehdään actioneilla'</span><span class="p">,</span>
    <span class="na">important</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="na">id</span><span class="p">:</span> <span class="mi">2</span>
  <span class="p">})</span>
<span class="p">})</span>
</code></pre></div></div>

<p>Reduceri laajenee seuraavasti</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">noteReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'NEW_NOTE'</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">case</span> <span class="s1">'TOGGLE_IMPORTANCE'</span><span class="p">:</span>
      <span class="kd">const</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span>
      <span class="kd">const</span> <span class="nx">noteToChange</span> <span class="o">=</span> <span class="nx">state</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">n</span> <span class="o">=&gt;</span> <span class="nx">n</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">id</span><span class="p">)</span>
      <span class="kd">const</span> <span class="nx">changedNote</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span><span class="nx">noteToChange</span><span class="p">,</span> <span class="na">important</span><span class="p">:</span> <span class="o">!</span><span class="nx">noteToChange</span><span class="p">.</span><span class="nx">important</span> <span class="p">}</span>
      <span class="k">return</span> <span class="nx">state</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span> <span class="nx">note</span><span class="p">.</span><span class="nx">id</span> <span class="o">!==</span> <span class="nx">id</span> <span class="p">?</span> <span class="nx">note</span> <span class="p">:</span> <span class="nx">changedNote</span> <span class="p">)</span>
    <span class="na">default</span><span class="p">:</span>
      <span class="k">return</span> <span class="nx">state</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Luomme tärkeyttä muuttaneesta muistiinpanosta kopion osasta 2 <a href="/osa2#muistiinpanon-tärkeyden-muutos">tutulla syntaksilla</a> ja korvaamme tilan uudella tilalla, mihin otetaan muuttumattomat muistiinpanot ja muutettavasta sen muutettu kopio <em>changedNote</em>.</p>

<h3 id="array-spread--syntaksi">array spread -syntaksi</h3>

<p>Koska reducerilla on nyt suhteellisen hyvät testit, voimme refaktoroida koodia turvallisesti.</p>

<p>Uuden muistiinpanon lisäys luo palautettavan tilan taulukon <em>concat</em>-funktiolla. Katsotaan nyt miten voimme toteuttaa saman hyödyntämällä Javascriptin <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_operator">array spread</a> -syntaksia:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">noteReducer</span> <span class="o">=</span> <span class="p">(</span><span class="nx">state</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">action</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s1">'NEW_NOTE'</span><span class="p">:</span>
      <span class="k">return</span> <span class="p">[...</span><span class="nx">state</span><span class="p">,</span> <span class="nx">action</span><span class="p">.</span><span class="nx">data</span><span class="p">]</span>
    <span class="k">case</span> <span class="s1">'TOGGLE_IMPORTANCE'</span><span class="p">:</span>
      <span class="c1">// ...</span>
    <span class="na">default</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">state</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Spread-syntaksi toimii seuraavasti. Jos määrittelemme</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">luvut</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</code></pre></div></div>

<p>niin <code>...luvut</code> hajottaa taulukon yksittäisiksi alkioiksi, eli voimme sijoittaa sen esim, toisen taulukon sisään:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[...</span><span class="nx">luvut</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
</code></pre></div></div>

<p>ja lopputuloksena on taulukko, jonka sisältö on <em>[1, 2, 3, 4, 5]</em>.</p>

<p>Jos olisimme sijoittaneet taulukon toisen sisälle ilman spreadia, eli</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="nx">luvut</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
</code></pre></div></div>

<p>lopputulos olisi ollut <em>[ [1, 2, 3], 4, 5]</em>.</p>

<p>Samannäköinen syntaksi toimii taulukosta <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Destructuring_assignment">destrukturoimalla</a> alkioita otettaessa siten, että se <em>kerää</em> loput alkiot:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">luvut</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>

<span class="kd">const</span> <span class="p">[</span><span class="nx">eka</span><span class="p">,</span> <span class="nx">toka</span><span class="p">,</span> <span class="p">...</span><span class="nx">loput</span><span class="p">]</span> <span class="o">=</span> <span class="nx">luvut</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">eka</span><span class="p">)</span>    <span class="c1">// tulostuu 1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">toka</span><span class="p">)</span>   <span class="c1">// tulostuu 2</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">loput</span><span class="p">)</span>  <span class="c1">// tulostuu [3, 4, 5, 6]</span>
</code></pre></div></div>

<h2 id="tehtäviä-5">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#redux-unicafe">5.17 ja 5.18</a></p>

<h3 id="lisää-toiminnallisuutta-ja-ei-kontrolloitu-lomake">Lisää toiminnallisuutta ja ei-kontrolloitu lomake</h3>

<p>Lisätään sovellukseen mahdollisuus uusien muistiinpanojen tekemiseen sekä tärkeyden muuttamiseen:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">generateId</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="nb">Number</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000000</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'NEW_NOTE'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">content</span><span class="p">:</span> <span class="nx">content</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">id</span><span class="p">:</span> <span class="nx">generateId</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">''</span>
  <span class="p">}</span>
  <span class="nx">toggleImportance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'TOGGLE_IMPORTANCE'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span>
    <span class="p">})</span>
  <span class="p">}</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">addNote</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name=</span><span class="s2">"note"</span> <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>lisää<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span><span class="o">=&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">onClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleImportance</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>
              <span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span> <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">?</span> <span class="s1">'tärkeä'</span> <span class="p">:</span> <span class="s1">''</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
          <span class="p">)</span><span class="si">}</span>
         <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Molemmat toiminnallisuudet on toteutettu suoraviivaisesti. Huomionarvoista uuden muistiinpanon lisäämisessä on nyt se, että toisin kuin aiemmat Reactilla toteutetut lomakkeet, emme ole nyt sitoneet lomakkeen kentän arvoa komponentin <em>App</em> tilaan. React kutsuu tälläisiä lomakkeita <a href="https://reactjs.org/docs/uncontrolled-components.html">ei-kontrolloiduiksi</a>.</p>

<blockquote>
  <p>Ei-kontrolloiduilla lomakkeilla on tiettyjä rajoitteita (ne eivät esim. mahdollista lennossa annettavia validointiviestejä, lomakkeen lähetysnapin disabloimista sisällön perusteella ym…), meidän käyttötapaukseemme ne kuitenkin tällä kertaa sopivat.
Voit halutessasi lukea aiheesta enemmän <a href="https://goshakkk.name/controlled-vs-uncontrolled-inputs-react/">täältä</a>.</p>
</blockquote>

<p>Muistiinpanon lisäämisen käsittelevä metodi on yksinkertainen, se ainoastaan dispatchaa muistiinpanon lisäävän actionin:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
  <span class="kd">const</span> <span class="nx">content</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'NEW_NOTE'</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">content</span><span class="p">:</span> <span class="nx">content</span><span class="p">,</span>
      <span class="na">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="na">id</span><span class="p">:</span> <span class="nx">generateId</span><span class="p">()</span>
    <span class="p">}</span>
  <span class="p">})</span>
  <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">''</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Uuden muistiinpanon sisältö saadaan suoraan lomakkeen syötekentästä, johon kentän nimeämisen ansiosta päästään käsiksi tapahtumaolion kautta <em>event.target.note.value</em></p>

<p>Tärkeyden muuttaminen tapahtuu klikkaamalla muistiinpanon nimeä. Käsittelijä on erittäin yksinkertainen:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">toggleImportance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'TOGGLE_IMPORTANCE'</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Kyseessä on jälleen tuttu <em>funktio, joka palauttaa funktion</em>, eli kullekin muistiinpanolle generoituu käsittelijäksi funktio, jolla on muistiinpanon yksilöllinen id. Esim. jos id olisi 12345, käsittelijä olisi seuraava:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">({</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'TOGGLE_IMPORTANCE'</span><span class="p">,</span>
    <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="mi">12345</span> <span class="p">}</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="action-creatorit">action creatorit</h3>

<p>Alamme huomata, että jo näinkin yksinkertaisessa sovelluksessa Reduxin käyttö yksinkertaistaa sovelluksen ulkoasusta vastaavaa koodia melkoisesti. React-komponenttien on oikeastaan tarpeetonta tuntea reduxin actionien tyyppejä ja esitysmuotoja. Eristetään ne erilliseen olioon, jonka metodit ovat <a href="https://redux.js.org/advanced/async-actions#synchronous-action-creators">action creatoreja</a>:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">actionFor</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">noteCreation</span><span class="p">(</span><span class="nx">content</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'NEW_NOTE'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span>
        <span class="nx">content</span><span class="p">,</span>
        <span class="na">important</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="na">id</span><span class="p">:</span> <span class="nx">generateId</span><span class="p">()</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="nx">importanceToggling</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
      <span class="na">type</span><span class="p">:</span> <span class="s1">'TOGGLE_IMPORTANCE'</span><span class="p">,</span>
      <span class="na">data</span><span class="p">:</span> <span class="p">{</span> <span class="nx">id</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Komponentin <em>App</em> ei tarvitse enää tietää mitään actionien sisäisestä esitystavasta:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span>
      <span class="nx">actionFor</span><span class="p">.</span><span class="nx">noteCreation</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">''</span>
  <span class="p">}</span>
  <span class="nx">toggleImportance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span>
      <span class="nx">actionFor</span><span class="p">.</span><span class="nx">importanceToggling</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="staten-välittäminen-propseissa-ja-contextissa">staten välittäminen propseissa ja contextissa</h3>

<p>Sovelluksemme on reduceria lukuunottamatta tehty samaan tiedostoon. Kyseessä ei tietenkään ole järkevä käytäntö, eli on syytä eriyttää <em>App</em> omaan moduuliinsa.</p>

<p>Herää kuitenkin kysymys miten <em>App</em> pääsee muutoksen jälkeen käsiksi <em>storeen</em>? Ja yleisemminkin, kun komponentti koostuu suuresta määrästä komponentteja, tulee olla jokin mekanismi, minkä avulla komponentit pääsevät käsiksi storeen.</p>

<p>Tapoja on muutama, käsitellään tässä osassa kahta helpoimmin ymmärrettävää. Parhaan tavan eli kirjaston React-redux määrittelevän <a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#connectmapstatetoprops-mapdispatchtoprops-mergeprops-options">connect</a>-metodin säästämme seuraavaan osaan, sillä se on hieman abstrakti ja on kenties hyvä totutella Reduxiin aluksi ilman connectin tuomia käsitteellisiä haasteita.</p>

<p>Yksinkertaisin vaihtoehto on välittää store propsien avulla. Sovelluksen käynnistyspiste <em>index.js</em> typistyy seuraavasti</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createStore</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'redux'</span>
<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="s1">'./App'</span>
<span class="k">import</span> <span class="nx">noteReducer</span> <span class="k">from</span> <span class="s1">'./noteReducer'</span>

<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">noteReducer</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(&lt;</span><span class="nc">App</span> <span class="na">store=</span><span class="si">{</span><span class="nx">store</span><span class="si">}</span><span class="p">/&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">))</span>
<span class="p">}</span>

<span class="nx">render</span><span class="p">()</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">render</span><span class="p">)</span>
</code></pre></div></div>

<p>Muutos omaan moduuliinsa eriytettyyn komponenttiin <em>App</em> on pieni, storeen viitataan <em>propsien</em> kautta <code>this.props.store</code>:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">actionFor</span> <span class="k">from</span> <span class="s1">'./actionCreators'</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span>
      <span class="nx">actionFor</span><span class="p">.</span><span class="nx">noteCreation</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">''</span>
  <span class="p">}</span>
  <span class="nx">toggleImportance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span>
      <span class="nx">actionFor</span><span class="p">.</span><span class="nx">importanceToggling</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">addNote</span><span class="si">}</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name=</span><span class="s2">"note"</span> <span class="p">/&gt;</span>
          <span class="p">&lt;</span><span class="nt">button</span> <span class="na">type=</span><span class="s2">"submit"</span><span class="p">&gt;</span>lisää<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
          <span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span>
            <span class="p">&lt;</span><span class="nt">li</span> <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span> <span class="na">onClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleImportance</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>
              <span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span> <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">?</span> <span class="s1">'tärkeä'</span> <span class="p">:</span> <span class="s1">''</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
          <span class="p">)</span><span class="si">}</span>
        <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">App</span>
</code></pre></div></div>

<p>Jos sovelluksessa on enemmän storea tarvitsevia komponentteja, tulee <em>App</em>-komponentin välittää <em>store</em> propseina kaikille sitä tarvitseville komponenteille.</p>

<p>Eriytetään uuden muistiinpanon luominen sekä muistiinpanojen lista ja yksittäisen muisiinpanon esittäminen omiksi komponenteiksi:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">NoteForm</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">addNote</span> <span class="o">=</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span>
      <span class="nx">actionFor</span><span class="p">.</span><span class="nx">noteCreation</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">note</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">''</span>
  <span class="p">}</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">form</span> <span class="na">onSubmit=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">addNote</span><span class="si">}</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">name=</span><span class="s2">"note"</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nt">button</span><span class="p">&gt;</span>lisää<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
      <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">Note</span> <span class="o">=</span> <span class="p">({</span><span class="nx">note</span><span class="p">,</span> <span class="nx">handleClick</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span><span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">li</span> <span class="na">onClick=</span><span class="si">{</span><span class="nx">handleClick</span><span class="si">}</span><span class="p">&gt;</span>
      <span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">content</span><span class="si">}</span> <span class="p">&lt;</span><span class="nt">strong</span><span class="p">&gt;</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">important</span> <span class="p">?</span> <span class="s1">'tärkeä'</span> <span class="p">:</span> <span class="s1">''</span><span class="si">}</span><span class="p">&lt;/</span><span class="nt">strong</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>
  <span class="p">)</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nx">NoteList</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">toggleImportance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span>
      <span class="nx">actionFor</span><span class="p">.</span><span class="nx">importanceToggling</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span>
          <span class="p">&lt;</span><span class="nc">Note</span>
            <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span>
            <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span>
            <span class="na">handleClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleImportance</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="si">}</span>
          <span class="p">/&gt;</span>
        <span class="p">)</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Komponenttiin <em>App</em> ei jää enää paljoa koodia:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nc">NoteForm</span> <span class="na">store=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="si">}</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nc">NoteList</span> <span class="na">store=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">.</span><span class="nx">store</span><span class="si">}</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Toisin kuin aiemmin ilman Reduxia tekemässämme React-koodissa, tapahtumankäsittelijät on nyt siirretty pois <em>App</em>-komponentista. Yksittäisen muistiinpanon renderöinnistä huolehtiva <em>Note</em> on erittäin yksinkertainen, eikä ole tietoinen siitä, että sen propsina saama tapahtumankäsittelijä dispatchaa actionin. Tälläisiä komponentteja kutsutaan Reactin terminologiassa <a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0">presentational</a>-komponenteiksi.</p>

<p><em>NoteList</em> taas on sellainen mitä kutsutaan <a href="https://medium.com/@dan_abramov/smart-and-dumb-components-7ca2f9a7c7d0">container</a>-komponenteiksi, se sisältää sovelluslogiikkaa, eli määrittelee mitä <em>Note</em>-komponenttien tapahtumankäsittelijät tekevät ja koordinoi <em>presentational</em>-komponenttien, eli <em>Notejen</em> konfigurointia.</p>

<p>Palaamme presentational/container-jakoon tarkemmin seuraavassa osassa.</p>

<p><em>storen</em> välittäminen sitä tarvitseviin komponentteihin propsien avulla on melko ikävää. Vaikka <em>App</em> ei itse tarvitse storea, sen on otettava store vastaan, pystyäkseen välittämään sen edelleen komponenteille <em>NoteForm</em> ja <em>NoteList</em>.</p>

<p>Tutustumme vielä tämän osan lopuksi <em>storen</em> välittämiseen Reactin <a href="https://reactjs.org/docs/context.html">contextin</a> avulla.</p>

<p>Manuaalin sanoin:</p>
<blockquote>
  <p>In some cases, you want to pass data through the component tree without having to pass the props down manually at every level. You can do this directly in React with the powerful “context” API.</p>
</blockquote>

<p>Reactin Context API on vielä kokeellinen ja se voi hävitä tulevista versiosta. Contextin käyttö ei olekaan kovin suositeltavaa. Katsomme kuitenkin mistä on kyse.</p>

<p>Asennetaan ensin contextin käyttöä helpottava <a href="https://github.com/reactjs/react-redux">react-redux</a>-kirjasto sekä contextien määrittelyyn tarvittava <em>prop-types</em>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm install react-redux prop-types <span class="nt">--save</span>
</code></pre></div></div>

<p>Muutetaan tiedostoa <em>index.js</em> seuraavasti:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">ReactDOM</span> <span class="k">from</span> <span class="s1">'react-dom'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">createStore</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'redux'</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Provider</span> <span class="p">}</span> <span class="k">from</span> <span class="s1">'react-redux'</span>
<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="s1">'./App'</span>
<span class="k">import</span> <span class="nx">noteReducer</span> <span class="k">from</span> <span class="s1">'./noteReducer'</span>

<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">createStore</span><span class="p">(</span><span class="nx">noteReducer</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
    <span class="p">&lt;</span><span class="nc">Provider</span> <span class="na">store=</span><span class="si">{</span><span class="nx">store</span><span class="si">}</span><span class="p">&gt;</span>
      <span class="p">&lt;</span><span class="nc">App</span><span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nc">Provider</span><span class="p">&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">))</span>
<span class="p">}</span>

<span class="nx">render</span><span class="p">()</span>
<span class="nx">store</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">render</span><span class="p">)</span>
</code></pre></div></div>

<p>Komponentti <em>App</em> on sijoitettu react-redux-kirjaston tarjoavan <a href="https://github.com/reactjs/react-redux/blob/master/docs/api.md#provider-store">Provider</a> komponentin lapseksi. Store on annettu <em>Providerille</em> propsina.</p>

<p>Provider määrittelee <em>storen</em> saataville komponentin <em>App</em> ja sen alikomponenttien <em>kontekstista</em>.</p>

<p>Koska <em>App</em> ei tarvitse itse storea, voi sen muuttaa muotoon:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nc">NoteForm</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nc">NoteList</span> <span class="p">/&gt;</span>
      <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><em>NoteList</em> muuttuu seuraavasti:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">React</span> <span class="k">from</span> <span class="s1">'react'</span>
<span class="k">import</span> <span class="nx">PropTypes</span> <span class="k">from</span> <span class="s1">'prop-types'</span>
<span class="k">import</span> <span class="nx">actionFor</span> <span class="k">from</span> <span class="s1">'../actionCreators'</span>
<span class="k">import</span> <span class="nx">Note</span> <span class="k">from</span> <span class="s1">'./Note'</span>

<span class="kd">class</span> <span class="nx">NoteList</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">toggleImportance</span> <span class="o">=</span> <span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span>
      <span class="nx">actionFor</span><span class="p">.</span><span class="nx">importanceToggling</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="p">}</span>
  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">(</span>
      <span class="p">&lt;</span><span class="nt">ul</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">getState</span><span class="p">().</span><span class="nx">map</span><span class="p">(</span><span class="nx">note</span> <span class="o">=&gt;</span>
          <span class="p">&lt;</span><span class="nc">Note</span>
            <span class="na">key=</span><span class="si">{</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span>
            <span class="na">note=</span><span class="si">{</span><span class="nx">note</span><span class="si">}</span>
            <span class="na">handleClick=</span><span class="si">{</span><span class="k">this</span><span class="p">.</span><span class="nx">toggleImportance</span><span class="p">(</span><span class="nx">note</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span><span class="si">}</span>
          <span class="p">/&gt;</span>
        <span class="p">)</span><span class="si">}</span>
      <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="nx">NoteList</span><span class="p">.</span><span class="nx">contextTypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">store</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">object</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Muutos on siis hyvin pieni. Nyt propsien sijaan storen viite on <code>this.context.store</code>. Komponentille on myös pakko määritellä sen vastaanottaman kontekstin tyyppi:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">NoteList</span><span class="p">.</span><span class="nx">contextTypes</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">store</span><span class="p">:</span> <span class="nx">PropTypes</span><span class="p">.</span><span class="nx">object</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ilman määrittelyä konteksti jää tyhjäksi.</p>

<p>Komponenttiin <em>NoteForm</em> tehtävä muutos on samanlainen. Koska <em>Note</em> ei riipu millään tavalla <em>storesta</em>, se jää muuttumattomaksi.</p>

<p>Tehdään sovellukseen vielä yksi parannus. Lisätään storea käyttäviin komponentteihin <em>NoteForm</em> ja <em>NoteList</em> seuraavan koodin sisältävät metodit <em>componentDidMount</em> ja <em>componentWillUnmount</em>:</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nx">NoteForm</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">{</span> <span class="nx">store</span> <span class="p">}</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">context</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">unsubscribe</span> <span class="o">=</span> <span class="nx">store</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(()</span> <span class="o">=&gt;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">forceUpdate</span><span class="p">()</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="nx">componentWillUnmount</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">unsubscribe</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Näin komponentit rekisteröityvät kuuntelemaan storessa tapahtuvia muutoksia ja niiden tapahtuessa uudelleenrenderöimään itsensä (ja lapsikomponenttinsa) metodilla <a href="https://reactjs.org/docs/react-component.html#forceupdate">forceUpdate</a>.</p>

<p>Nyt pääsemme eroon tiedostossa <em>index.js</em> tapahtuneesta koko sovelluksen uudelleenrenderöinnistä ja koodi yksinkertaistuu muotoon.</p>

<div class="language-react highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">ReactDOM</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span>
  <span class="p">&lt;</span><span class="nc">Provider</span> <span class="na">store=</span><span class="si">{</span><span class="nx">createStore</span><span class="p">(</span><span class="nx">noteReducer</span><span class="p">)</span><span class="si">}</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nc">App</span> <span class="p">/&gt;</span>
  <span class="p">&lt;/</span><span class="nc">Provider</span><span class="p">&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div></div>

<p>Redux-sovelluksen tämänhetkinen koodi on kokonaisuudessaan <a href="https://github.com/FullStack-HY/redux-notes/tree/part5-6">githubissa</a>, tagissa <em>part5-6</em>.</p>

<p>Egghead.io:ssa on ilmaiseksi saatavilla Reduxin kehittäjän Dan Abramovin loistava tutoriaali <a href="https://egghead.io/courses/getting-started-with-redux">Getting started with Redux</a>. Neljässä viimeisessä videossa käytettävää <em>connect</em>-metodia käsittelemme vasta kurssin seuraavassa osassa.</p>

<h2 id="tehtäviä-6">Tehtäviä</h2>

<p>Tee nyt tehtävät <a href="/tehtävät#redux-anekdootit">5.19-5.21</a></p>

  </div>

</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading"></h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
             Full stack open 2018 
          </li>
          <li>
            <a href="mailto:mluukkai@cs.helsinki.fi">mluukkai@cs.helsinki.fi</a>
          </li>
          <li>
            <a href="https://github.com/mluukkai"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">mluukkai</span></a>

          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
           
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">
          <img alt="Creative Commons -lisenssi" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png"
          />
        </a>
        <br />Materiaali on lisensoitu
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons BY-NC-SA 3.0 -lisenssillä</a>.
        </p>
      </div>
    </div>

  </div>

</footer>

  </body>

</html>
